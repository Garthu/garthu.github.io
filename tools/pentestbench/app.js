const STORAGE_KEY = "atlas_mvp_values";

const recipes = [
  {
    category: "Recon",
    items: [
      { name: "Nmap bÃ¡sico", cmd: "nmap -sC -sV -p {port} {ip}" },
      { name: "Nmap full", cmd: "nmap -p- -T4 {ip}" },
      { name: "HTTP title", cmd: "curl -sI http://{ip}:{port} | head" }
    ]
  },
  {
    category: "Content discovery",
    items: [
      { name: "Gobuster dir", cmd: "gobuster dir -u http://{ip}:{port}/ -w {wordlist} -t 50" },
      { name: "FFUF", cmd: "ffuf -u http://{ip}:{port}/FUZZ -w {wordlist} -t 80" }
    ]
  },
  {
    category: "Auth",
    items: [
      { name: "Hydra SSH", cmd: "hydra -l {user} -P {wordlist} ssh://{ip} -t 4" }
    ]
  }
];

const els = {
  ip: document.getElementById("ip"),
  port: document.getElementById("port"),
  user: document.getElementById("user"),
  wordlist: document.getElementById("wordlist"),
  content: document.getElementById("content"),
  btnReset: document.getElementById("btnReset"),
  btnExpand: document.getElementById("btnExpand")
};

function loadValues() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}

function saveValues(values) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
}

function getValues() {
  return {
    ip: els.ip.value.trim(),
    port: els.port.value.trim(),
    user: els.user.value.trim(),
    wordlist: els.wordlist.value.trim()
  };
}

function applyValues(values) {
  els.ip.value = values.ip ?? "";
  els.port.value = values.port ?? "";
  els.user.value = values.user ?? "";
  els.wordlist.value = values.wordlist ?? "";
}

function renderCmd(template, values) {
  return template.replace(/\{(\w+)\}/g, (_, k) => values[k] ?? "");
}

async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    return false;
  }
}

function render() {
  const values = getValues();
  saveValues(values);

  els.content.innerHTML = "";

  recipes.forEach((group, idx) => {
    const cat = document.createElement("div");
    cat.className = "category";
    cat.dataset.open = "true";

    const header = document.createElement("div");
    header.className = "catHeader";
    header.innerHTML = `<strong>${group.category}</strong><span>${group.items.length} itens</span>`;

    const items = document.createElement("div");
    items.className = "items";

    group.items.forEach((it) => {
      const cmd = renderCmd(it.cmd, values);

      const item = document.createElement("div");
      item.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = it.name;

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Copiar";
      btn.addEventListener("click", async () => {
        const ok = await copyToClipboard(cmd);
        btn.textContent = ok ? "Copiado" : "Falhou";
        setTimeout(() => (btn.textContent = "Copiar"), 900);
      });

      top.appendChild(name);
      top.appendChild(btn);

      const pre = document.createElement("pre");
      pre.textContent = cmd;

      item.appendChild(top);
      item.appendChild(pre);
      items.appendChild(item);
    });

    header.addEventListener("click", () => {
      const isOpen = cat.dataset.open === "true";
      cat.dataset.open = (!isOpen).toString();
      items.style.display = isOpen ? "none" : "grid";
    });

    cat.appendChild(header);
    cat.appendChild(items);
    els.content.appendChild(cat);
  });
}

function bind() {
  [els.ip, els.port, els.user, els.wordlist].forEach((el) => {
    el.addEventListener("input", render);
  });

  els.btnReset.addEventListener("click", () => {
    applyValues({ ip: "", port: "", user: "", wordlist: "" });
    render();
  });

  els.btnExpand.addEventListener("click", () => {
    const cats = Array.from(document.querySelectorAll(".category"));
    const anyClosed = cats.some((c) => c.dataset.open === "false");
    cats.forEach((cat) => {
      const items = cat.querySelector(".items");
      cat.dataset.open = anyClosed ? "true" : "false";
      items.style.display = anyClosed ? "grid" : "none";
    });
  });
}

(function init() {
  applyValues(loadValues());
  bind();
  render();
})();
